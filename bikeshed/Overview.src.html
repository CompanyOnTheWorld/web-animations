<h1>Web Animations</h1>
<pre class='metadata'>
Status: ED
ED: http://dev.w3.org/fxtf/web-animations/
Shortname: web-animations
Level: 1
Editor: Brian Birtles, Mozilla Japan, bbirtles@mozilla.com
Editor: Shane Stephens, Google Inc, shans@google.com
Editor: Alex Danilo, Google Inc, adanilo@google.com
Editor: Tab Atkins, Google Inc, jackalmage@gmail.com
Group: fxtf
Abstract: This specification defines a model for synchronization and timing of
    changes to the presentation of a Web page.
    This specification also defines an application programming interface for
    interacting with this model and it is expected that further specifications
    will define declarative means for exposing these features.
</pre>

<link href='web-animations.css' rel='stylesheet' type='text/css'>
<script src='MathJax/MathJax.js?config=MML_SVGorMML,local/local' type='text/javascript'></script>

<h2>Introduction</h2>
<div class='informative-bg'><em>This section is non-normative</em>

Web Animations defines a model for supporting animation and
synchronization on the Web platform.
It is intended that other specifications will build on this model and
expose its features through declarative means.
In addition, this specification also defines a programming interface to
the model that may be implemented by user agents that provide support
for scripting.

<h3>Use cases</h3>

The Web Animations model aims at two broad areas of application:

:   User interface effects
::  Animation can be used to give visual clues and feedback to make
    a user interface more readily comprehensible.

    For example, a user action results in a table row being
    removed to represent an item being removed from a shopping cart.cd -
    In such a case, fading the row to transparent and then shifting
    the subsequent rows up to fill the space over a few hundred
    milliseconds provides the user with clear feedback as to the
    results of their action as opposed to instantly removing the row
    from the DOM.

    To support this scenario not only are the animated effects of
    fading and shifting required, but so is synchronization, both
    between the animations, and between animations and scripted
    actions (removing the table row from the DOM after the animations
    have completed).

:   Storytelling and visualization
::  Another type of animation uses the animated effect to convey
    a story or represent some information.
    Unlike user interface effects which are largely a presentational
    adjunct to the content, these animations form an essential part of
    the content presented to the user.

    For example, in an animated cartoon two cats fly through space
    to another planet leaving a rainbow trail behind them.
    After arriving at the planet a change of scene occurs and the user
    should decide whether or not the cats enter a magic mountain by
    selecting one of two preset destinations in the scene.

    This scenario requires the following features:
    
    *   animated effects for moving characters along a path as well as
        warping a path (the rainbow trail),
    *   synchronization that allows some actions to happen
        simultaneously (the two cats moving) and others in sequence
        (the change of scene),
    *   play control to allow rewinding the cartoon, or changing its
        playback rate to accommodate particular learning or
        accessibility needs,
    *   the ability to trigger animations in response to user input

    Similar use cases in this category include visualising physical
    phenomena such as spring motion for educational purposes,
    or visualising data such as the prevalence of a disease over
    a geographical space over a year whereby animation is used to
    present the time-based component of the data.

<h3>Relationship to other specifications</h3>

CSS Transitions [<cite><a class="bibref" href="#bib-CSS3-TRANSITIONS">CSS3-TRANSITIONS</a></cite>], CSS Animations                                                               
[<cite><a class="bibref" href="#bib-CSS3-ANIMATIONS">CSS3-ANIMATIONS</a></cite>], and SVG [<cite><a class="bibref" href="#bib-SVG112">SVG112</a></cite>] all provide mechanisms \
that                                                                                                                                                                             
generate animated content on a Web page.                                                                                                                                         
Although the three specifications provide many similar features,                                                                                                                 
they are described in different terms.                                                                                                                                           
This specification proposes an abstract animation model that                                                                                                                     
encompasses the common features of all three specifications.                                                                                                                     
This model is backwards-compatible with the current behavior of these                                                                                                            
specifications such that they can be defined in terms of this model                                                                                                              
without any observable change.

The animation features in SVG 1.1 are defined in terms of SMIL                                                                                                                   
Animation [<cite><a class="bibref" href="#bib-SMIL-ANIMATION">SMIL-ANIMATION</a></cite>].                                                                                        
It is intended that by defining SVG's animation features in terms of                                                                                                             
the Web Animations model, the dependency between SVG and SMIL                                                                                                                    
Animation can be removed.                                                                                                                                                        

As with Timing control for script-based animations (commonly referred
to as &ldquo;requestAnimationFrame&rdquo;) [[RAF]],
the programming interface component of this specification allows
animations to be created from script.
The animations created using the interface defined in this
specification, however, once created, are executed entirely by the
user agent meaning they share the same performance characteristics as
animations defined by markup.
Using this interface it is possible to create animations
from script in a simpler and more performant manner.

The time values used within the programming interface
correspond with those used in Timing control for script-based
animations [[RAF]] and their execution order to defined such that the
two interfaces can be used simultaneously without conflict.

The programming interface component of this specification makes                                                                                                                  
some additions to interfaces defined in HTML5 [<cite><a class="bibref" href="#bib-HTML5">HTML5</a></cite>].

<h3>Overview of this specification</h3>

This specification begins by defining an abstract model for animation.                                                                                                           
This is followed by a programming interface defined in terms of the                                                                                                              
abstract model.                                                                                                                                                                  
The programming interface is defined in terms of the abstract model                                                                                                              
and is only relevant to user agents that provide scripting support.

</div>

<h2>Web Animations model overview</h2>

<div class='informative-bg'><em>This section is non-normative</em>

At a glance, the Web Animations model consists of two largely
independent pieces, a <em>timing model</em> and an <em>animation
model</em>.  The role of these pieces is as follows:

:   Timing model                                                                                                                                                            
::  Takes a moment in time and converts it to a proportional distance                                                                                                                
    within a single iteration of an animation called the <em>time                                                                                                                    
    fraction</em>.                                                                                                                                                                   
    An <em>iteration index</em> is also generated for animations                                                                                                                     
    that vary as they repeat.                                                                                                                                                        
:   Animation model                                                                                                                                                         
::  Takes the <em>time fractions</em> and <em>iteration indices</em>                                                                                                                 
    produced by the timing model and converts them into a series of values                                                                                                           
    to apply to the target properties and attributes.                                                                                                                                
                                                                                                                                                                              
Graphically, this flow can be represented as follows:                                                                                                                            
<div class="figure">                                                                                                                                                             
<img src="img/timing-and-animation-models.svg" width="600" alt="Overview of the operation of the Web Animations model.">                                                         
</div>                                                                                                                                                                           
<p class="caption">                                                                                                                                                              
Overview of the operation of the Web Animations model.<br>                                                                                                                       
The current time is input to the timing model which produces a time                                                                                                              
fraction and an iteration index.<br>                                                                                                                                             
These parameters are used as input to the animation model which produces                                                                                                         
the values to apply.<br>                                                                                                                                                         
</p>                                                                                                                                                                             

For example, consider an animation that:                                                                                                                                         

*   starts after 3 seconds
*   runs twice,
*   takes 2 seconds every time, and
*   changes the width of a rectangle from 50 pixels to 100 pixels.

The first three points apply to the timing model.                                                                                                                                
At a time of 6 seconds, it will calculate that the animation should be
half-way through its second iteration and produces the result 0.5.                                                                                                               
The animation model then uses that information to calculate a width                                                                                                              

This specification begins with the timing model and then proceeds to                                                                                                             
the animation model.

</div>

<h2>Timing model</h2>

This section describes and defines the behavior of the Web Animations
timing model.

<h3>The timing model at a glance</h3>

<div class='informative-bg'>

<em>This section is non-normative</em>

Two features characterise the Web Animations timing model: it is
<em>stateless</em> and it is <em>hierarchical</em>.
 
<h4>Stateless</h4>

The Web Animations timing model operates by taking an input time and
producing an output time fraction.
Since the output is based solely on the input time and is independent
of previous inputs, the model may be described as stateless.
This gives the model the following properties:


:   Frame-rate independent
::  Since the output is independent of previous inputs, the rate at
    which the model is sampled will not affect its progress.
    Provided the input times are proportional to the progress of
    real-world time, animations will progress at an identical rate
    regardless of the capabilities of the device running them.
:   Direction-agnostic
::  Since the sequence of inputs is insignificant, the model is
    directionless.
    This means that the model can be sampled in reverse or even in
    a backwards and forwards pattern without requiring any specialized
    handling.
:   Constant-time seeking
::  Since each input is independent of the previous input, the
    processing required to perform a seek operation, even far into the
    future, is at least potentially constant.

There are a few exceptions to the stateless behavior of the timing
model.

Firstly, a number of methods defined in the <a
href="#programming-interface" section>programming interface</a> to the model
provide play control such as pausing an animation.
These methods are defined in terms of the time at which they are
called and are therefore stative.
These methods are provided primarily for convenience and are not part
of the core timing model but are layered on top.

Likewise, <a>player events</a> are fired when the first sample occurs
at the limit of the <a>source content</a>.
This too is stative behavior but is part of the play control layered
on top of the timing model.

Similarly, the <a href="#limiting-the-current-time" section>limiting
behavior</a> of players means that dynamic changes to the end time of
the media (source content) of a player may produce a different result
depending on when the change occurs.
This behavior is somewhat unfortunate but has been deemed intuitive
and consistent with HTML.
As a result, the model can only truly be described as stateless
<em>in the absence of dynamic changes to its timing properties</em>.

Finally, each time the model is sampled, it can be considered to
establish a temporary state.
While this temporary state affects the values returned from the <a
href="#programming-interface" section>programming interface</a>, it has no
influence on the subsequent samples and hence does not conflict with
the stateless qualities described above.

<h4>Hierarchical</h4>

The other characteristic feature of the Web Animations timing model is
that time is inherited.
Time begins with a monotonically increasing time source and cascades
down a number of steps to each animation.
At each step, time may be shifted backwards and forwards, scaled,
reversed, paused, and repeated.

<div class="figure">
  <img src="img/time-hierarchy.svg" width="600"
            alt="A hierarchy of timing nodes">
</div>
<p class="caption">
  A hierarchy of timing nodes.
  Each node in the tree derives its time from its parent node.
  At the root of the tree is the global clock.
</p>

A consequence of this hierarchical arrangement is that complex
animation arrangements can be reversed, scheduled, accelerated and so
on as a whole unit since the manipulations applied to the parent
cascade down to its <a>descendants</a>.
Furthermore, since time has a common source, it is easy to synchronize
animations.

</div>

<h3>Timing model concepts</h3>

In Web Animations, timing is based on a hierarchy of time relationships
between timing nodes.
Parent nodes provide timing information to their child nodes in the form
of <a>time values</a>.
A <dfn>time value</dfn> is a real number which nominally represents
a number of milliseconds from some moment.
The connection between <a>time values</a> and wall-clock milliseconds
may be obscured by any number of transformations applied to the value as
it passes through the time hierarchy.

<p class="annotation">
In the future we may have timelines that are based on UI gestures in
which case the connection between time values and milliseconds will be
weakened even further.
</p>

Periodically, the user agent will trigger an update to the timing model
in a process called <dfn>sampling</dfn>.
On each <dfn>sample</dfn> the <a>time values</a> of each timing node are
updated.

Note: A more precise definition of when the model is updated when scripting is
    involved is provided in <a
    href="#script-execution-and-live-updates-to-the-model"
    section></a>.

<h3>The global clock</h3>

At the root of the Web Animations timing hierarchy is the <a>global
clock</a>.

The <dfn>global clock</dfn> is a source of monotonically increasing
<a>time values</a> unaffected by adjustments to the system clock.
The <a>time values</a> produced by the <a>global clock</a> represent
wall-clock milliseconds from an unspecified historical moment.
Because the zero time of the <a>global clock</a> is not specified,
the absolute values of the <a>time values</a> produced by the <a>global
clock</a> are not significant, only their rate of change.

Note: The <a>global clock</a> is not exposed in the <a
    href="#programming-interface">programming interface</a> and nor is it
    expected to be exposed by markup.
    As a result the moment from which <a>global clock</a> <a>time values</a>
    are measured, that is, the zero time of the clock, is
    implementation-dependent.
    One user agent may measure the number of milliseconds since the the user
    agent was loaded whilst another may use the time when the device was
    started.
    Both approaches are acceptable and produce no observable difference
    in the output of the model.


<h3>Timelines</h3>

A <dfn>timeline</dfn> provides a source of <a>time values</a> for the
purpose of synchronization.

Typically, a <a>timeline</a> is tied to the <a>global clock</a> such
that its absolute time is calculated as a fixed offset from the time of
the <a>global clock</a>.
This offset is established by designating some moment as the timeline's
<dfn>zero time</dfn> and recording the <a>time value</a> of the
<a>global clock</a> at that moment.
At subsequent moments, the <a>time value</a> of the timeline is
calculated as the difference between the current <a>time value</a> of
the <a>global clock</a> and the value recorded at the <a>zero time</a>.

<p class="annotation">
  Note that we anticipate that other types of timelines may be introduced
  in the future that are not tied to the global clock.
  For example, a timeline whose time values are related to the progress of
  a UI gesture.
</p>

Since a <a>timeline</a> may be defined relative to a moment that has yet
to occur, it may not always be able to return a meaningful <a>time
value</a>.
A <a>timeline</a> is considered to be <dfn>not started</dfn> when it is
in such a state that it cannot produce a <a>time value</a>.

Issue: Should this be renamed to something like &ldquo;inactive&rdquo; so we
    can accommodate possible future timelines that may, after starting,
    become unable to return a meaningful <a>time value</a>?

<h4>The document timeline</h4>

Each document has a <a>timeline</a> called the <dfn>document
timeline</dfn>.
The <a>time values</a> of the <a>document timeline</a> are calculated
as a fixed offset from the <a>global clock</a> such that the <a>zero
time</a> corresponds to the <a
href="http://www.w3.org/TR/navigation-timing/#dom-performancetiming-navigationstart">
<code>navigationStart</code></a> moment [[!NAVIGATION-TIMING]].
Prior to this moment, the <a>document timeline</a> is <a>not
started</a>.

<div class="informative-bg"><em>This section is non-normative</em>

Since the <a>document timeline</a> is tied to the <a>global
clock</a> by a fixed offset, <a>time values</a> reported by the
<a>document timeline</a> increase monotonically.
Furthermore, since no scaling is applied, these <a>time values</a>
are proportional to wall-clock milliseconds.

Since the <a>time values</a> of the <a>document timeline</a> are
relative to the <code>navigationStart</code> time,
<code>document.timeline.currentTime</code> will roughly correspond to
<a href="http://www.w3.org/TR/hr-time/#dom-performance-now">
<code>Performance.now()</code></a>
[[HR-TIME]] with the exception that
<code>document.timeline.currentTime</code> does not change within
a script execution block as defined in <a
href="#script-execution-and-live-updates-to-the-model" section></a>.

</div>

<h3>Players</h3>

<div class="informative-bg"><em>This section is non-normative</em>

The children of a <a>timeline</a> are called <em>players</em>.
A player takes an <a>animation node</a> which is a static
description of some timed behavior and binds it to a <a>timeline</a>
so that it runs.
A player also allows run-time control of the connection between the
<a>animation node</a> and its <a>timeline</a> by providing pausing,
seeking, and speed control.
The relationship between a player and an <a>animation node</a> is
analogous to that of a DVD player and a DVD.
</div>

A <dfn>player</dfn> connects a single <a>animation node</a>, called
its <dfn>source content</dfn>, to a <a>timeline</a> and provides
playback control.

A <a>player</a>'s <dfn title="player start time">start time</dfn> is the
<a>time value</a> of its <a>timeline</a> when its <a>source content</a>
is scheduled to begin playback.

When a <a>player</a> is created, it is assigned a globally unique
sequence number called the <dfn>player sequence number</dfn>.
This number is used to resolve the sort order of players for a variety
of situations such as combining animations, queuing events, and
returning the list of current players.

<h4>The current time of a player</h4>

<a>Players</a> provide a <a>time value</a> to their <a>source
content</a> called the player's <dfn>current time</dfn>.

The calculation of the <a>current time</a> is as follows:

<blockquote>
  <code><a>current time</a> =
  (<var>timeline time</var> - <a
   title="player start time">start time</a>)
  &times; <a title="player playback rate">playback rate</a></code>
  <p>
    <em>unless</em> the <a>hold time</a> is <em>not</em> null, in which
    case the <a>current time</a> is equal to the <a>hold time</a>.
  </p>
</blockquote>

Where:

*   <var>timeline time</var> is the current <a>time value</a> of the
    <a>timeline</a> with which this <a>player</a> is associated.
*   <var>start time</var> is the player's <a
    title="player start time">start time</a>.
*   <var>playback rate</var> is the player's <a
    title="player playback rate">playback rate</a> value described in
    <a href="#speed-control" section></a>.
*   <a>hold time</a> is the value described in 
    <a href="#seeking--pausing-and-limiting-properties" section></a>.

The procedure for performing manual updates to the <a>current time</a>
is defined in <a href="#performing-a-seek" section></a>.

If the <a>timeline</a> with which the <a>player</a> is associated is
<a>not started</a>, then the <a>current time</a> is null.

<!--
  Delayed start:

  Likewise, if the player's <a title="player start time">start time</a>
  is <a>not resolved</a>, then the <a>current time</a> is
  <code>null</code>.
-->

<!--
  Delayed start:

  qualify the following with "or when the start time has not been
  resolved"?
-->

It is often useful to manipulate the <a>current time</a> of a player
even when its associated <a>timeline</a> is <a>not started</a>.
For example, this is useful for pre-seeking a player.
For this purpose, we have the following additional definitions:

:   <dfn>effective timeline time</dfn>
::  The current <a>time value</a> of the <a>timeline</a> associated
    with a <a>player</a> unless the timeline is <a>not started</a>, in
    which case the <var>effective timeline time</var> is zero.
:   <dfn>effective current time</dfn>
::  <!--
    Delayed start:
    Or if the start time is <a>not resolved</a> use the current timeline
    time
    -->
    The result of evaluating the <a>current time</a> as above
    but substituting the <a>effective timeline time</a> for the
    <var>timeline time</var>.

<h4>Seeking, pausing and limiting</h4>

Seeking, pausing and limiting a player are closely related and are
described here together.

<h5>Introduction to seeking</h5>

<div class="informative-bg"><em>This section is non-normative</em>

Changing the current playback position of a player, that is, its
<a>current time</a>, can be used to rewind its <a>source content</a>
to its start point, fast-forward to a point in the future, or to
provide ad-hoc synchronization between players.

Changing the <a>current time</a> of a player has the side effect of
shifting its <a title="player start time">start time</a> as
illustrated below.

<div class="figure">
<img src="img/seeking.svg" width="600"
    alt="The effect of seeking a player.">
</div>
<p class="caption">
At time <var>t</var>, a seek is performed on the player changing its
<a>current time</a> from 1.5s to 2s.<br>
</p>

It is possible to seek a player even if its <a>timeline</a> is
<a>not started</a>.
Once the timeline begins, the player will begin playback from the
seeked time.

</div>

<h5>Introduction to pausing</h5>

<div class='informative-bg'><em>This section is non-normative</em>

Pausing can be used to temporarily suspend a <a>player</a>.
Like seeking, pausing controls the <a>current time</a> of
a player by updating its <a title="player start time">start
time</a>.
The result is illustrated below.

<div class="figure">
<img src="img/pausing.svg" width="600"
    alt="The effect of pausing a player.">
</div>
<p class="caption">
The effect of pausing a <a>player</a>.<br>
Whether pausing before or after a <a>player</a>'s <a
title="player start time">start time</a>,
the <a>player</a>'s <a title="player start time">start time</a> is
delayed by the duration of the interval during which it was paused.
</p>

</div>

<h5>Limiting the current time</h5>

<div class='informative-bg'><em>This section is non-normative</em>

Players in the real world such as DVD players or cassette players
typically continue playing until they reach the end of their media
at which point they stop.
If such players are able to play in reverse, they typically stop
playing when they reach the beginning of their media.
In order to emulate this behavior and to provide consistency
with HTML's <a
href="http://www.w3.org/TR/html5/embedded-content-0.html#media-elements">media
elements</a> [[HTML5]], the <a>current time</a> of Web Animations'
players do not play forwards beyond the <a>end time</a> of their
<a>source content</a> or play backwards past time zero.
This behavior is called <em>limiting</em>.

Graphically, the effect of limiting is shown below.

<div class="figure">
<img src="img/limiting.svg" width="500"
    alt="The effect of pausing a player.">
</div>
<p class="caption">
The effect of limiting on a <a>player</a> with a start time of 1s,
a source content of length 3s, and a positive <a>player playback
rate</a>.
After the <a>current time</a> of the player reaches the end of the
source content, it is capped at 3s.
</p>

It is possible, however, to <em>seek</em> the <a>current time</a> of
a <a>player</a> to a time past the end of the <a>source content</a>.
When doing so, the <a>current time</a> will not progress but the
player will act as if it had been paused at the seeked time.

This allows, for example, seeking the <a>current time</a> of
a player with <em>no</em> <a>source content</a> to 5s.
If <a>source content</a> with an <a>end time</a> later than 5s is
later associated with the player, playback will begin from the 5s
mark.

Similar behavior to the above scenarios may arise when the
length of a player's <a>source content</a> changes.

When the <a>player playback rate</a> is negative, the <a>current
time</a> does not progress past time zero although it may be seeked
to a negative time.

Limiting the <a>current time</a> acts like a sort of automatic
pausing and is accomplished using the same machinery as pausing.

</div>

<h5>Seeking, pausing and limiting properties</h5>

<a>Players</a> track two properties related to seeking,
pausing and limiting.


:   paused state
::  A boolean value that is true if the player is currently paused.
    The <a>paused state</a> is initially false.
:   hold time
::  The <a>effective current time</a> to maintain while the player is
    paused or effectively paused either because it has reached the end
    of its <a>source content</a> and is <a>limited</a>, or because it
    has a zero <a>playback rate</a>.
    When none of these conditions apply, the <a>hold time</a> is
    null.
    The <a>hold time</a> is initially null.

In addition to these properties, implementations are required to
keep track of the last calculated value of the <a>current time</a>
in order to produce correct limiting behavior (see <a
href="#automatically-updating-the-hold-time"
section></a>).

<h5>Calculating the player start time</h5>

The <a>player start time</a> value is both a stored and
a calculated value.
When a player is paused, the value is calculated from the <a>hold
time</a>.
When a player is not paused, the stored value is used.

The value of the <a>player start time</a> at a given moment is
based on the <a>paused state</a> as follows:

<div class="switch">

:   If the <a>paused state</a> is true
::  Return the result of evaluating
    <code><var>effective timeline time</var>
    - <a>hold time</a> / <a>player playback rate</a></code>.<br>
    If <a>player playback rate</a> is zero, return negative infinity.
:   Otherwise,
::  Return the stored value for the <a>player start time</a>.

</div>

<h5>Updating the player start time</h5>

The <a title="player start time">start time</a> of a <a>player</a>
is updated to a new time, <var>new start time</var>, as follows:

<div class="switch">

:   If the <a>paused state</a> is true,
::  Let the <a>hold time</a> be the result of evaluating
    <code><var>timeline time</var> - <var>new start time</var>
    &times; <a>player playback rate</a></code>.
:   Otherwise,
::

    1.  Let the stored value of <a>player start time</a> be <var>new
        start time</var>.
    2.  Set the <a>hold time</a> to null.

</div>

<h5>Automatically updating the hold time</h5>

The <a>hold time</a> is updated prior to each time the <a>current
time</a> is calculated when <em>all</em> of the following conditions
are true:

*   the <a>paused state</a> is false, and
*   the <a>player playback rate</a> is not zero, and
*   the <a>timeline</a> is <a title="not started">started</a>.

When all the above conditions are satisfied, the following steps are
performed:

1.  Let the <dfn>unlimited current time</dfn> be the result of
    evaluating the <a>current time</a> using a <a>hold time</a> of
    null.
2.  Let the <dfn>source content end</dfn> be the <a>end time</a>
    of the player's <a>source content</a>.
    If the player has no <a>source content</a>, let the
    <em>source content end</em> be zero.
3.  The <a>hold time</a> is updated using the first matching
    condition from below:

    <div class='switch'>
    
    :   If the <a>player playback rate</a> &lt; 0 and
        the <a>unlimited current time</a> &le; 0,
    ::  Let the <a>hold time</a> be zero.
    :   If the <a>player playback rate</a> &gt; 0 and
        the <a>unlimited current time</a> &ge; <a>source content
        end</a>,
    ::  Let the <a>hold time</a> be the maximum value of
        the last calculated value of <a>current time</a>
        and <a>source content end</a>.
        If there is no previously calculated value of <a>current
        time</a> or it is null,
        let the <a>hold time</a> be <a>source content end</a>.
    :   Otherwise,
    ::
    
        1.  If the <a>hold time</a> is not null,
            set the stored value of the <a>player start time</a>
            to the result of evaluating <code><var>timeline
            time</var> - <a>hold time</a>
            / <a>player playback rate</a></code>.
        2.  Let the <a>hold time</a> be null.
    
    </div>

<h5>Updating the paused state</h5>

The procedure for updating the <a>paused state</a> is as
follows:

1.  Let <var>new value</var> be the new paused state to set.
2.  If <var>new value</var> equals the current <a>paused state</a>,
    abort this procedure.
3.  The next step depends on the current <a>paused state</a> as
    follows,
    
    <div class='switch'>
    
    :   If <a>paused state</a> is true and the <a>player</a> is not
        <a>limited</a>,
    ::
    
        1.  Set the <em>stored</em> value of <a>player start
            time</a> to the <em>current calculated</em> value of
            <a>player start time</a> as defined in 
            <a href="#calculating-the-player-start-time" section></a>
        2.  Set the <a>hold time</a> to null.

    :   Otherwise if the <a>paused state</a> is false,
    ::  Record the current value of the <a>effective current time</a>
        as <a>hold time</a>.
    :   Otherwise,
    ::  Do nothing.

4. Update <a>paused state</a> to <var>new value</var>.

<h5>Performing a seek</h5>

<dfn>Seeking</dfn> is the process of updating a player's <a>current
time</a> to a desired value.
It is achieved using the following procedure:

1.  Let <var>seek time</var> be the desired <a>time value</a> for
    the player's <a>current time</a>.
2.  If <em>any</em> of the following conditions are true:

    *   the <a>paused state</a> is true, or
    *   the <a>player playback rate</a> &gt; 0 and <var>seek
        time</var> &ge; <a>source content end</a> (as defined in 
        <a href="#automatically-updating-the-hold-time" section></a>), or
    *   the <a>player playback rate</a> &lt; 0 and <var>seek 
        time</var> &le; zero, or
    *   the <a>player playback rate</a> = 0

    then set <a>hold time</a> to <var>seek time</var>.
3.  If <em>all</em> of the following are true:

    *   the <a>paused state</a> is false, and
    *   the <a>player playback rate</a> is not zero

    then:
    
    1.  Reset the <a>hold time</a> to null.
    2.  Set the stored value of <a>player start time</a>
        to the result of evaluating <code><var>effective timeline
        time</var> - <var>seek time</var> / <a>player
        playback rate</a></code>.
    3.  Set the player's <a>finished flag</a> to false.

    Since <a>seeking</a> effectively updates the player's <a>current
    time</a> it also causes the &ldquo;previously calculated value of
    <a>current time</a>&rdquo; as used by the procedure for updating the
    <a>hold time</a> to be updated (see <a
    href="#automatically-updating-the-hold-time" section></a>).

<h5>Limited players</h5>

A <a>player</a> is said to be <dfn>limited</dfn> when either of the
following conditions are true:

1.  <a>player playback rate</a> &gt; 0 and <a>effective current
    time</a> &ge; the player's <a>source content end</a>
    (as defined in <a href="#automatically-updating-the-hold-time"
    section></a>), or
2.  <a>player playback rate</a> &lt; 0 and <a>effective current
    time</a> &le; zero.

<h4>Speed control</h4>

<div class="informative-bg">

The rate of play of a player can be controlled by setting its
<em>playback rate</em>.
For example, setting a playback rate of 2 will cause the player's
<a>current time</a> to increase at twice the rate of its <a>timeline</a>.
Similarly, a playback rate of -1 will cause the player's <a>current
time</a> to decrease at the same rate as the <a>time values</a> from
its <a>timeline</a> increase.

Note that <a>animation nodes</a> also have a <a
title="animation node playback rate">playback rate</a> associated
with them that behaves differently to that defined here.

</div>

<a>Players</a> have a <dfn title="player playback
rate">playback rate</dfn> that provides a scaling factor from the rate
of change of the associated <a>timeline</a>'s <a>time values</a> to
the player's <a>current time</a>.
The <a title="player playback rate">playback rate</a> is initially 1.

Setting a player's <a title="player playback rate">playback rate</a>
to zero effectively pauses the player but without affecting the
player's <a>paused state</a>.

<h5>Updating the playback rate</h5>

Changes to the <a title="player playback rate">playback rate</a>
trigger a compensatory seek so that that the player's
<a>current time</a> is unaffected by the change to the playback
rate.

The procedure is as follows:

1.  Let <var>previous time</var> be the value of the <a>effective
    current time</a> before updating the <a
    title="player playback rate">playback rate</a>.
2.  Update the <a title="player playback rate">playback rate</a> to
    the new value.
3.  Seek to <var>previous time</var> using the procedure defined in
    <a href="#performing-a-seek" section></a>.
4.  If the new value for the <a
    title="player playback rate">playback rate</a> differs in sign
    to the previous non-zero playback rate, set the <a>finished
    flag</a> to false.

<h4>Player events</h4>

As <a>players</a> play they report changes to
their status through <dfn title="player event">player events</dfn>.

<a>Player events</a> are a property of the Web Animations timing
model.
As a result they are dispatched even when the <a>source content</a> of
the player is absent or has no observable result.

<h5>Types of player events</h5>

:   <dfn title="finish player event">finish</dfn>
::  Queued whenever a sample occurs that causes a <a>player</a>'s
    <a>finished flag</a> to be newly true.

    *   Bubbles: no
    *   Cancelable: no
    *   Context Info: currentTime, documentTime

To assist dispatching <a title="finish player event">finish
events</a>, <a>players</a> maintain a <dfn>finished flag</dfn> that
is initially false when the player is created.

During each <a>sample</a>, the <a>finished flag</a> is updated such
that it is set to true if the player is <a>limited</a> and false
otherwise.

<h5>Event parameters</h5>

<a>Player events</a> have an associated <a>event
current time</a> and <a>event timeline time</a>.

The <dfn>event current time</dfn> is the <a>current time</a> of the
<a>player</a> that generated the event at the moment the event is
queued.
This will be null if the <a>player</a> was not associated with
a <a>timeline</a> at the time the event was generated.

The <dfn>event timeline time</dfn> is the <a>time value</a> of the
<a>timeline</a> with which the <a>player</a> that generated the
event is associated at the moment the event is queued.
This will be null if the <a>player</a> was not associated with
a <a>timeline</a> at the time the event was generated.

<h5>Propagation path</h5>

The <a
href="http://www.w3.org/TR/DOM-Level-3-Events/#glossary-propagation-path">propagation
path</a> for a <a>player event</a> generated by <var>player</var>,
is simply <var>player</var> itself.

<h5>Sequence of events</h5>

The sequence in which <a>player events</a> are queued is in
ascending order by <a>event timeline time</a>.
If two <a>player events</a> have the same <a>event document
time</a>, the <a>player events</a> are queued in ascending order by
<a>player sequence number</a> of the <a>players</a> that generated
the events.

<h5>Event dispatch</h5>

<dfn>Events are queued</dfn> whenever <a>sampling</a> regularly
occurs (that is, <em>not</em> when the timing model is evaluated due
to <a>seeking</a> or structural changes to the hierarchy of
<a>animation nodes</a>).

As a result, <a>seeking</a> a <a>player</a> to the limit of its
<a>source content</a> and back to a point within its <a>source
content</a> within the same script execution block will <em>not</em>
trigger a <a title="finish player event">finish</a> event.

<h3>Animation nodes</h3>

An <dfn>animation node</dfn> is an abstract term referring to an item in
the timing hierarchy.

<h4>Relationship between animation nodes and players</h4>

The <a>source content</a> of a <a>player</a>, if set, is a type of
<a>animation node</a>.
The <a>source content</a> of a <a>player</a> is said to be <dfn
title="directly associated with a player">directly associated</dfn>
with that player.

<a>Animation nodes</a> can be combined together into a hierarchy using
<a>animation groups</a> (see <a href="#grouping-and-synchronization"
section></a>).
Only the <a>root</a> <a>animation node</a> of such a hierarchy can be
<a>directly associated with a player</a>.
If an <a>animation node</a> that has a <a>parent animation group</a>
is designated as the <a>source content</a> of a <a>player</a>, the
<a>animation node</a> is removed from its <a>parent animation
group</a> before being associated with the <a>player</a>.

An <a>animation node</a> is <dfn>associated with a player</dfn> if it
is <a>directly associated with a player</a> or if it has an
<a>ancestor</a> <a>animation group</a> that is <a>directly associated
with a player</a>.
At a given moment, an <a>animation node</a> can be <a
title="associated with a player">associated</a> with at most one
<a>player</a>.

An <a>animation node</a>, <var>node</var>, is <dfn>associated with
a timeline</dfn>, <var>timeline</var>, if <var>node</var> is
<a>associated with a player</a> which, in turn, is associated with
<var>timeline</var>.

<h4>Types of animation nodes</h4>

This specification defines two types of <a>animation nodes</a>:

* <a>animations</a>, and
* <a>animation groups</a>.

All types of <a>animation nodes</a> define a number of common
properties which are described in the following sections.

<h4>The active interval</h4>

<div class="informative-bg">

The period that an <a>animation node</a> is scheduled to run is
called its <a>active interval</a>.
Each <a>animation node</a> has only one such interval.

The lower bound of the <a>active interval</a> is determined by the
<a title="animation node start time">start time</a> of the
<a>animation node</a> but may be shifted by a <a>start delay</a> on
the <a>animation node</a>.

The upper bound of the interval is determined by the <a>active
duration</a>.

The relationship between the <a
title="animation node start time">start time</a>, <a>start
delay</a>, and <a>active duration</a> is illustrated below.

<div class="figure">
<img src="img/active-interval-examples.svg" width="600"
    alt="Examples of the effect of the start delay on the endpoints
        of the active interval">
</div>
<p class="caption">
Examples of the effect of the <a>start delay</a> on the endpoints of
the <a>active interval</a>.<br>
(a) An animation node with no delay; the <a
title="animation node start time">start time</a> and beginning of
the <a>active interval</a> are coincident.<br>
(b) An animation node with a positive delay; the beginning of the
<a>active interval</a> is deferred by the delay.<br>
(c) An animation node with a negative delay; the beginning of the
<a>active interval</a> is brought forward by the delay.
</p>

An <a>end delay</a> may also be specified but is primarily only of
use when sequencing animations such as by using a <a>sequence
animation group</a>.
        
</div>
        
<a>Animation nodes</a> define an <dfn>active interval</dfn> which is
the period of time during which the node is scheduled to produce its
effect with the exception of <a>fill modes</a> which apply outside the
<a>active interval</a>.

The lower bound of the <a>active interval</a> is defined by the
combination of the animation node's 
<a title="animation node start time">start time</a> and <a>start delay</a>.
An <a>animation node</a>'s 
<dfn title="animation node start time">start time</dfn> is the moment at
which the <a>parent animation group</a>,
if any, has scheduled the <a>animation node</a> to begin.
It is expressed in <a>inherited time</a>.
In most cases, including the case when the <a>animation node</a> has
no <a>parent animation group</a>,
the <a title="animation node start time">start time</a> is zero.
The singular exception is <a>sequence animation groups</a> which set
the <a title="animation node start time">start times</a> of their
children as described in <a
href="#the-start-time-of-children-of-an-animation-sequence" section></a>.

In addition to the <a title="animation node start time">start
time</a>, an <a>animation node</a> also has a <dfn>start delay</dfn>
which is an offset from the <a
title="animation node start time">start time</a>.
Unlike the <a title="animation node start time">start time</a> which
is determined by the <a>parent animation group</a>, the <a>start
delay</a> is a property of the <a>animation node</a> itself.

The lower bound of the <a>active interval</a> of an <a>animation
node</a>, expressed in <a title="inherited time">inherited time
space</a>, is the sum of the <a
title="animation node start time">start time</a> and the <a>start
delay</a>.

These definitions are incorporated in the calculation of the <a>local
time</a> (see <a href="#local-time-and-inherited-time" section></a>) 
and <a>active time</a>.

The length of the <a>active interval</a> is called the <dfn>active
duration</dfn>, the calculation of which is defined in <a
href="#calculating-the-active-duration" section></a>.

Similar to the <a>start delay</a>, an <a>animation node</a> also has
an <dfn>end delay</dfn> which may be used to delay the <a
title="animation node start time">start time</a> of the <a>next
sibling</a> in a <a>sequence animation group</a>.

<h4>Local time and inherited time</h4>

<div class="informative-bg">

In Web Animations all times are relative to some point of reference.
These different points of reference produce different <em>time
spaces</em>.

This can be compared to coordinate spaces as used in computer
graphics.
The zero time of a time space is analogous to the origin of
a coordinate space.

Just as with coordinate spaces, time spaces can also be nested.
<a>Animation groups</a> typically perform some
transformations on the <a>time values</a> they
receive from their <a title="parent animation group">parent</a> or
<a>player</a> before passing on the transformed <a>time values</a>
to their children.
Child <a>animation nodes</a> then operate <em>within</em> that
transformed time space.

Children take the transformed time values from their
parent&mdash;called the <a>inherited time</a>&mdash; and add their
<a title="animation node start time">start time</a> to establish
their own <a title="local time">local time space</a> as illustrated
below.

<div class="figure">
<img src="img/local-time.svg" width="600"
    alt="Inherited time and local time.">
</div>
<p class="caption">
Inherited time and local time.<br>
At time <var>t</var>, the <a>inherited time</a> is 2.5.<br>
For <a>animation node</a> (a) which has a <a
  title="animation node start time">start time</a> of 1, the
  <a>local time</a> is 1.5.<br>
For <a>animation node</a> (b) which has a <a
  title="animation node start time">start time</a> of 1
  and a <a>start delay</a> of 1,
  the <a>local time</a> is also 1.5
  since <a>local time</a> is based on an <a>animation node</a>'s
  <a title="animation node start time">start time</a> only,
  and not on its <a>start delay</a>.
</p>

</div>

For an <a>animation node</a>, the <dfn>inherited time</dfn> at
a given moment is based on the first matching condition from the
following:

<div class='switch'>

:   If the <a>animation node</a> has a <a>parent animation
    group</a>,
::  the inherited time is the <a>parent animation group</a>'s current
    <a>transformed time</a>.
:   If the <a>animation node</a> is directly associated with
    a <a>player</a>,
::  the inherited time is the <a>current time</a> of the
    <a>player</a>.
:   Otherwise,
::  the inherited time is <code>null</code>.

</div>

The <dfn>local time</dfn> of an <a>animation node</a> is the
<a>animation node</a>'s <a>inherited time</a> minus its <a
title="animation node start time">start time</a>.
If the <a>inherited time</a> is <code>null</code> then the local time
is also <code>null</code>.

<h4>Animation node phases and states</h4>

<div class="informative-bg"><em>This section is non-normative</em>

At a given moment, an <a>animation node</a> may be in one of three
possible <em>phases</em>.
If an <a>animation node</a> has a <code>null</code> <a>local
time</a> it will not be in any phase.

The different phases are illustrated below.

<div class="figure">
<img src="img/animation-node-phases-and-states.svg" width="700"
    alt="An example of the different phases and states used to
         describe an animation node.">
</div>
<p class="caption">
An example of the different phases and states used to describe
an <a>animation node</a>.
</p>

The phases are as follows:
:   <a>before phase</a>
::  The <a>animation node</a>'s <a>local time</a> falls before the
    node's <a>active interval</a>.
:   <a>active phase</a>
::  The <a>animation node</a>'s <a>local time</a> falls inside the
    node's <a>active interval</a>.
:   <a>after phase</a>
::  The <a>animation node</a>'s <a>local time</a> falls after the
    node's <a>active interval</a>.

In addition to these phases, an <a>animation node</a> may also be
described as being in one of several overlapping <em>states</em>.
These states are only established for the duration of a single
sample and are primarily a convenience for describing stative parts
of the model.

These states and their useage within the model are summarised as
follows:

:   <a>in play</a>
::  Corresponds to an <a>animation node</a> whose <a>active time</a>
    is changing on each sample.
    This occurs when the <a>animation node</a> <em>and all its
    ancestors</em> are in the <a>active phase</a>.
    <a>Animations</a> only &ldquo;move&rdquo; when they are
    <a>in play</a>.

    It is possible for an <a>animation node</a> to be in the
    <a>active phase</a> but not <a>in play</a>.
    For example, if an <a>animation node</a> has a <a>parent
    animation group</a> that causes the animation node's <a>active
    interval</a> to be clipped and both parent and child apply the
    same <a>fill mode</a>, the child <a>animation node</a> may be
    effectively be snapshotted within the <a>active phase</a>
    despite no longer being <a>in play</a>.
    
:   <a>current</a>
::  Corresponds to an <a>animation node</a> that is either <a>in
    play</a> or may become <a>in play</a> in the future.
    This will be the case if the <a>animation node</a> is <a>in
    play</a> or in its <a>before phase</a>, <em>or</em> it has an
    ancestor for which this is true thereby opening up the
    possibility that this <a>animation node</a> might play again
    (e.g.  due to repeating).

    This state is used in the <a
    href="#programming-interface">programming interface</a> to
    identify all <a>animations</a> and <a>players</a> that are
    likely to be of interest.

    Furthermore, the <a>current</a> state provides an important
    definition for managing the amount of memory required by
    implementations.
    Assuming a monotonically increasing <a>timeline</a> an
    implementation can safely discard all <a>animation nodes</a>
    that are <em>not</em> <a>current</a> and not referenced
    elsewhere provided they take care to preserve any fill values.
    This is because such <a>animation nodes</a> will no longer have
    any dynamic effect.

:   <a>in effect</a>
::  Corresponds to an <a>animation node</a> that has a resolved
    <a>active time</a>.
    This occurs when either the <a>animation node</a> is in its
    <a>active phase</a> or outside the <a>active interval</a> but at
    a time where the node's <a>fill mode</a> (see <a
    href="#fill-behavior" section></a>) causes its
    <a>active time</a> to be resolved.
    Only <a>in effect</a> <a>animations</a> apply a result to
    their target.

The normative definition of each of these states follows.

</div>

An <a>animation node</a> is in the <dfn>before phase</dfn> if the
animation node's <a>local time</a> is not <code>null</code> and is
less than the node's <a>start delay</a>.

An <a>animation node</a> is in the <dfn>active phase</dfn> if
<em>all</em> of the following conditions are met:

1.  the <a>animation node</a>'s <a>local time</a> is not
    <code>null</code>, and
2.  the <a>animation node</a>'s <a>local time</a> is <em>greater than
    or equal</em> to its <a>start delay</a>, and
3.  the <a>animation node</a>'s <a>local time</a> is <em>less
    than</em> the sum of its <a>start delay</a> and <a>active
    duration</a>.

An <a>animation node</a> is in the <dfn>after phase</dfn> if the
animation node's <a>local time</a> is not <code>null</code> and is
<em>greater than or equal</em> to the sum of its <a>start delay</a>
and <a>active duration</a>.

An <a>animation node</a> is <dfn>in play</dfn> if <em>all</em>
of the following conditions are met:

1.  the <a>animation node</a> is in the <a>active phase</a>, and
2.  the <a>animation node</a> has a <a>parent animation group</a> that
    is <a>in play</a> or else is <a>directly associated with
    a player</a> that is not <a>limited</a>.

An animation node is <dfn>current</dfn> if it <em>any</em> of the
following conditions is true:

*   it is in the <a>before phase</a>, or
*   it is <a>in play</a>, or
*   it has a <a>parent animation group</a> and the
    <a>parent animation group</a> is <a>current</a>.

An animation node is <dfn>in effect</dfn> if its <a>active time</a> as
calculated according to the procedure in <a
href="#calculating-the-active-time" section></a> is not
<code>null</code>.

<h3>Fill behavior</h3>

The effect of an <a>animation node</a> when it is not <a>in play</a> is
determined by its <dfn>fill mode</dfn>.

The possible <a>fill modes</a> are:

*   none,
*   forwards,
*   backwards, and
*   both.

The normative definition of these modes is incorporated in the
calculation of the <a>active time</a> in <a
href="#calculating-the-active-time" section></a>.

<h4>Fill modes</h4>

<div class='informative-bg'><em>This section is non-normative</em>

The effect of each <a>fill mode</a> is as follows:

:   none
::  The animation node has no effect when it is not <a>in play</a>.
:   forwards</dt>
::  When the animation node is in the <a>after phase</a>,
    or when the animation node is in the <a>active phase</a> but an
    <a>ancestor</a> is in its <a>after phase</a>,
    the animation node will produce the same <a
    title="transformed time">transformed time value</a> as the last
    moment it is scheduled to be <a>in play</a>.

    For all other times that the animation node is not <a>in play</a>,
    it will have no effect.
:   backwards
::  When the animation node is in the <a>before phase</a>,
    or when the animation node is in the <a>active phase</a> but an
    <a>ancestor</a> is in its <a>before phase</a>,
    the animation node will produce the same <a
    title="transformed time">transformed time value</a> as the earliest
    moment that it is scheduled to be <a>in play</a>.

    For all other times that the animation node is not <a>in play</a>,
    it will have no effect.
:   both</dt>
::  When the animation node or an <a>ancestor</a> is in its <a>before
    phase</a>, <span class="prop-value">backwards</span> fill behavior
    is used.

    When the animation node or an <a>ancestor</a> is in its <a>after
    phase</a>, <span class="prop-value">forwards</span> fill behavior is
    used.

Some examples of the these fill modes are illustrated below.

<div class="figure">
  <img src="img/animation-state-and-fill-behavior.svg" width="600"
    alt="Examples of various fill modes and the states produced.">
</div>
<p class="caption">
  Examples of various fill modes and the states produced.<br>
  (a) fill mode &lsquo;none&rsquo;. The animation node has no effect
      outside its active interval.<br>
  (b) fill mode &lsquo;forwards&rsquo;. After the active interval has
      finished, the timed value continues to maintain a fill value.<br>
  (c) fill mode &lsquo;backwards&rsquo;. The animation node produces
      a fill value until the start of the active interval.<br>
  (d) fill mode &lsquo;both&rsquo;. Both before and after the active
      interval the animation node produces a fill value.
</p> 

Note: setting a fill mode has no bearing on the endpoints of the
    <a>active interval</a>.
    However, the fill mode <em>does</em> have an effect on various other
    properties of the timing model since the <a>active time</a> of an
    animation node is only defined (that is, not <code>null</code>) inside
    the <a>active interval</a> <em>or</em> when a fill is applied.

<div class="issue">
Currently <a>timing functions</a> that generate results outside the
range [0, 1] will behave unexpectedly when applied to animation
groups, as children will increase iterations or enter into fill mode
rather than continuing to extrapolate along their defined behavior
(which is what they would do if the timing function applied to them
directly).

To fix this it is possible we will wish to introduce 'overflow' fill
modes that respond to time values larger than or smaller than the
active time range by extrapolating rather than filling.

See <a
href='http://lists.w3.org/Archives/Public/public-fx/2013AprJun/0184.html'>section
15 (Overflowing fill) of minuted discussion from Tokyo 2013 F2F</a>.
</div>

</div>

<h3>Repeating</h3>

<h4>Iteration intervals</h4>

It is possible to specify that an animation node should repeat
a fixed number of times or indefinitely.
This repetition occurs <em>within</em> the <a>active interval</a>.
The span of time during which a single repetition takes place is
called an <dfn>iteration interval</dfn>.

Unlike the <a>active interval</a>, an animation node can have multiple
<a>iteration intervals</a> although typically only the interval
corresponding to the <a>current iteration</a> is of interest.

The length of a single iteration is called the <dfn>iteration
duration</dfn>.
The initial <a>iteration duration</a> of an animation node is simply
its <a>intrinsic iteration duration</a>.

The <dfn>intrinsic iteration duration</dfn> of an animation node is
zero, however some specific types of animation node such as
<a>animation groups</a> override this behavior and provide an
alternative intrinsic duration (see <a
href="#the-intrinsic-iteration-duration-of-an-animation-group"
section></a> and <a
href="#the-intrinsic-iteration-duration-of-an-animation-sequence"
section></a>).

The <a>iteration duration</a> of an <a>animation node</a> may be set
by the author to represent a value other than the <a>intrinsic
iteration duration</a>.

<div class="informative-bg"><em>This section is non-normative</em>

Comparing the <a>iteration duration</a> and the <a>active
duration</a> we have:

:   Iteration duration
::  The time taken for a single iteration of the animation node to
    complete.
:   Active duration
::  The time taken for the entire animation node to complete,
    including repetitions.
    This may be longer or shorter than the <a>iteration duration</a>.

The relationship between the <a>iteration duration</a> and <a>active
duration</a> is illustrated below.

<div class="figure">
  <img src="img/iteration-intervals.svg" width="600"
      alt="Comparison of the iteration duration and active time.">
</div>
<p class="caption">
  A comparison of the <a>iteration duration</a> and <a>active
  duration</a> of an animation node with an <a>iteration count</a> of
  2.5.
  Note that the <a>iteration duration</a> for the final iteration does
  not change, it is simply cut-off by the <a>active duration</a>.
</p>

</div>

<h4>Controlling iteration</h4>

The number of times an <a>animation node</a> repeats is called its
<dfn>iteration count</dfn>.
The <a>iteration count</a> is a real number greater than or equal to
zero.
The <a>iteration count</a> may also be positive infinity to represent
that the <a>animation node</a> repeats indefinitely.

In addition to the <a>iteration count</a>, <a>animation nodes</a> also
have an <dfn>iteration start</dfn> property which specifies an offset
into the series of iterations at which the <a>animation node</a>
should begin.
The <a>iteration start</a> is a finite real number greater than or
equal to zero.

The behavior of these parameters is defined in the calculations in <a
href="#core-animation-node-calculations" section></a>.

<div class="informative-bg"><em>This section is non-normative</em>

The effect of the <a>iteration count</a> and <a>iteration start</a>
parameters is illustrated below.

<div class="figure">
  <img src="img/iteration-count-and-start.svg" width="600"
    alt="The effect of the iteration count and iteration start parameters">
</div>
<p class="caption">
  The effect of the <a>iteration count</a> and <a>iteration start</a>
  parameters.<br>
  In the first case the <a>iteration count</a> is 2.5 resulting in the
  third iteration being cut-off half way through its <a>iteration
  interval</a>.<br>
  The second case is the same but with an <a>iteration start</a> of
  0.5.
  This causes the <a>animation node</a> to begin half way through the
  first iteration.
</p>

Unlike the <a>iteration count</a> parameter, the <a>iteration
start</a> parameter does not effect the length of the <a>active
duration</a>.

Note that values of <a>iteration start</a> greater than or equal to
one are generally not useful unless used in combination with an
<a>animation effect</a> that has an <a>iteration composite
operation</a> of 
<a title="iteration composite operation accumulate">accumulate</a>.

</div>

<h4>Iteration time space</h4>

<div class="informative-bg"><em>This section is non-normative</em>

We have already encountered different time spaces in describing
<a>local time</a> and <a>inherited time</a> (see <a
href="#local-time-and-inherited-time" section></a>).
Repetition introduces yet another time space: the iteration time
space.


<em>Iteration time space</em> is a time space whose zero time is the
beginning of an animation node's current iteration.


Within the Web Animations model we also refer to <a>active
time</a> which is a time relative to the beginning of the active
interval.
This time space, however, is internal to the model and not exposed in
the programming interface or in markup.


These time spaces are illustrated below.

<div class="figure">
  <img src="img/time-spaces.svg" width="600"
    alt="A comparison of local time, active time, and iteration time.">
</div>
<p class="caption">
A comparison of local time, active time, and iteration time for an
animation with a iteration duration of 1s and an iteration count of
2.5.
</p>

Note: While the time spaces themselves are not bounded, Web
    Animations defines <a>active time</a> and <a>iteration
    time</a> such that they are clamped to a set range as shown in the
    diagram.
    For example, whilst a time of -1 second is a valid time in
    <em>active time space</em>, the procedure for calculating the
    <a>active time</a> defined in <a
    href="#calculating-the-active-time" section></a> will
    never return a negative value.

In addition to these time spaces we can also refer to the
<em>document time space</em> which is time space of the <a>time
values</a> of the <a>document timeline</a> of the <a
href="http://www.w3.org/TR/html5/browsers.html#active-document">active
document</a>.

</div>

<h4>Interval timing</h4>

<div class="informative-bg"><em>This section is non-normative</em>

When an animation node repeats we must define the behavior at the
iteration boundaries.
For this and indeed for all interval-timing, Web Animations uses an
endpoint-exclusive timing model.
This means that whilst the begin time of an interval
is included in the interval, the end time time is not.
In interval notation this can written <code>[begin, end)</code>.
This model provides sensible behavior when intervals are repeated and
sequenced since there is no overlap between the intervals.


In the examples below, for the repeated node, at local time 1s,
the iteration time is 0.
For the sequenced nodes, at inherited time 1s, only node B will be
<a>in play</a>; there is no overlap.

<div class="figure">
  <img src="img/endpoint-exclusive-timing.svg" width="600"
    alt="Illustration of end-point exclusive timing.">
</div>
<p class="caption">
  Illustration of end-point exclusive timing. For both repeated and
  sequenced animation nodes there is no overlap at the boundaries
  between intervals.
</p>

An exception to this behavior is that when performing a <a
href="#fill-behavior">fill</a>, if the fill begins at an
interval endpoint, the endpoint is used.
This behavior falls out of the algorithm given in <a
href="#calculating-the-iteration-time"
section></a> and is illustrated below.

<div class="figure">
  <img src="img/endpoint-exclusive-timing-and-fill.svg" width="600"
    alt="Effect of iterations and fill on iteration time.">
</div>
<p class="caption">
  After one iteration, the iteration time is 0, but after two iterations
  (and thereonwards), the iteration time is equal to the iteration
  duration due to the special behavior defined when an animation node
  fills.
</p>

</div>

<h3>Animation node speed control</h3>

Like <a>players</a>, <a>animation nodes</a> also have a <dfn
title="animation node playback rate">playback rate</dfn> parameter.
The <a title="animation node playback rate">playback rate</a> of
an <a>animation node</a> is a finite real number that acts as
a multiplier when calculating the <a>animation node</a>'s <a>transformed
time</a> from its <a>local time</a>.

The effect of setting the <a title="animation node playback
rate">playback rate</a> of an <a>animation node</a> differs from the
setting the <a title="player playback rate">playback rate</a> on
a player.  Its behavior is defined in the timing calculations given in
<a href="#core-animation-node-calculations" section></a>.

<div class="informative-bg"><em>This section is non-normative</em>

In summary, the behavior of the <a title="animation node playback
rate">playback rate</a> of an <a>animation node</a> is as follows:

*   The <a title="animation node playback rate">playback rate</a> is
    applied only to the <a>active interval</a> of an <a>animation
    node</a> and not to the time while it is <a
    title="start delay">delayed</a> or <a title="fill mode">filling</a>.

*   Setting a negative <a title="animation node playback rate">playback
    rate</a> on an <a>animation node</a> causes the <a>animation
    node</a> to begin at the end of its <a>active interval</a>.
    This differs from the <a title="player playback rate">playback
    rate</a> on a <a>player</a>.
    Setting a <a title="player playback rate">playback rate</a> on
    a <a>player</a> to a negative value at a moment before the
    <a>player</a>'s </a>source content</a> has begun, will result in the
    <a>source content</a> never playing.

*   Setting the <a title="animation node playback rate">playback
    rate</a> of an <a>animation node</a> affects the calculated value of
    the <a>active duration</a> (see <a
    href="#calculating-the-active-duration"
    section></a>).

*   Changing the <a title="animation node playback rate">playback
    rate</a> of an <a>animation node</a> whose <a>local time</a> is
    within its <a>active interval</a> will cause it to jump.
    This is because the <a>active duration</a> will be updated but the
    <a>local time</a> will not.

    Furthermore, if other <a>animation nodes</a> depend on the
    <a>animation node</a>'s <a>active duration</a>, such as sibling
    <a>animation node</a> in a <a>sequence animation group</a>, they
    too may jump as a result of setting the <a>animation node</a>'s <a
    title="animation node playback rate">playback rate</a>.

    For runtime speed control the <a
    title="player playback rate">playback rate</a> of the
    <a>player</a> should be used.

</div>

<h3>Core animation node calculations</h3>

<h4>Overview</h4>

<div class="informative-bg"><em>This section is non-normative</em>

At the core of the Web Animations timing model is the process that
takes an <a>inherited time</a> value and converts it to an
<a>iteration time</a>.


Following this further transformations are applied before resulting at
a final <a>transformed time</a>.


The first step in this process is to calculate the bounds of the
<a>active interval</a> which is determined by the <a>active
duration</a>.

This process is illustrated below.

<div class="figure">
  <img src="img/active-duration-calculation.svg" width="650"
    alt="Calculation of the active duration.">
</div>
<p class="caption">
  Calculation of the <a>active duration</a> is based on
  multiplying the <a>iteration duration</a> by the <a>iteration
  count</a> and then dividing by the <a
  title="animation node playback rate">playback rate</a>.
</p>
<p>
  The process for calculating the <a>active duration</a> is normatively
  defined in <a href="#calculating-the-active-duration"
  section></a>.
</p>
<p>
  Having established the <a>active duration</a>, the process for
  transforming an <a>animation node</a>'s <a>inherited time</a> into its
  <a>transformed time</a> is illustrated below.
</p>
<div class="figure">
  <img src="img/time-calculations.svg" width="650"
    alt="An overview of timing model calculations.">
</div>
<p class="caption">
  An overview of timing model calculations.<br>
  (1) The <a>inherited time</a> is converted into a <a>local time</a> by
  incorporating the <a title="animation node start time">start
  time</a>.<br>
  (2) The <a>local time</a> is converted into an <a>active time</a> by
  incorporating the <a>start delay</a>.<br>
  (3) The <a>playback rate</a> and <a>iteration start</a> properties are
  applied to the <a>active time</a> to produce the <a>scaled active
  time</a>.<br>
  (4) The <a>scaled active time</a> is then converted to an offset
  within a single iteration: the <a>iteration time</a>.<br>
  (5) The <a>iteration time</a> is converted into a <a>directed time</a>
  by incorporating the <a>playback direction</a>.<br>
  (6) Finally, a timing function is applied to the <a>directed
  time</a> to produce the <a>transformed time</a>.
</p>

The first step, calculating the <a>local time</a> is described in <a
href="#local-time-and-inherited-time" section></a>.
Steps 2 to 4 in the diagram are described in the following sections.
Steps 5 and 6 are described in
<a href="#calculating-the-directed-time" section></a>
and
<a href="#calculating-the-transformed-time" section></a>
respectively.

</div>


<h4>Calculating the active duration</h4>

In order to calculate the <a>active duration</a> we first define the
<a>repeated duration</a> as follows:

<blockquote>
  <dfn>repeated duration</dfn> =
    <code><a>iteration duration</a> &times;
          <a>iteration count</a></code>
    <p>
      If either the <a>iteration duration</a> or <a>iteration count</a>
      are zero, the <a>repeated duration</a> is zero.
    </p>
    <p class="note">
      This clarification is needed since the result of infinity
      multiplied by zero is undefined according to IEEE 754-2008.
    </p>
</blockquote>

The <a>active duration</a> is calculated according to the following
steps:

1.  If the <a title="animation node playback rate">playback rate</a> is
      zero, return <code>Infinity</code>.
2.  Otherwise, return <code><a>repeated duration</a> / abs(<a
      title="animation node playback rate">playback rate</a>)</code>.

<h4>Transforming the local time</h4>

<h5>Calculating the active time</h5>

The <dfn>active time</dfn> is based on the <a>local time</a>
and <a>start delay</a>.
However, it is only defined when the <a>animation node</a> should
produce an output and hence depends on its <a>fill mode</a> and
phase as well as the phase of its <a>parent animation group</a>, if
any, as follows,

<div class="switch">

:   If the animation node is in the <a>before phase</a>,
::  The result depends on the first matching condition from the
    following,

    <div class="switch">
    
    :   If the animation node has a <a>parent animation group</a>
        and that parent animation group is in the <a>after
        phase</a>,
    ::  Return <code>null</code>.
    :   If the <a>fill mode</a> is <span
        class="prop-mode">backwards</span> or <span
        class="prop-mode">both</span>,
    ::  Return zero.
    :   Otherwise,
    ::  Return <code>null</code>.
    
    </div>

:   If the animation node is in the <a>active phase</a>,
::  The result depends on the first matching condition from the
    following,
    
    <div class="switch">
    
    :   If the animation node has a <a>parent animation group</a>
        and that parent animation group is in the <a>before
        phase</a>, and the <a>fill mode</a> of this animation node
        is <span class="prop-value">none</span> or <span
        class="prop-value">forwards</a>,
    ::  Return <code>null</code>.
    :   If the animation node has a <a>parent animation group</a>
        and that parent animation group is in the <a>after
        phase</a>, and the <a>fill mode</a> of this animation node
        is <span class="prop-value">none</span> or <span
        class="prop-value">backwards</a>,
    ::  Return <code>null</code>.
    :   Otherwise,
    ::  Return <code><a>local time</a> - <a>start delay</a></code>.
    
    </div>

:   If the animation node is in the <a>after phase</a>,
::  The result depends on the first matching condition from the
    following,
    
    <div class="switch">
    
    :   If the animation node has a <a>parent animation group</a>
        and that parent animation group is in the <a>before
        phase</a>,
    ::  Return <code>null</code>.
    :   If the <a>fill mode</a> is <span
        class="prop-mode">forwards</span> or <span
        class="prop-mode">both</span>,
    ::  Return the <a>active duration</a>.
    :   Otherwise,
    ::  Return <code>null</code>.
    
    </div>
    
:   Otherwise (the <a>local time</a> is <code>null</code>),
::  Return <code>null</code>.

</div>

<h5>Calculating the scaled active time</h5>

Before the <a>active time</a> can be converted to an <a>iteration
time</a> we must factor in the <a>animation node</a>'s <a
title="animation node playback rate">playback rate</a> and
<a>iteration start</a>.
The result is called the <a>scaled active time</a>.

In order to calculate the <a>scaled active time</a> we first
define the <a>start offset</a> as follows:

<blockquote>
  <dfn>start offset</dfn> =
    <code><a>iteration start</a> &times;
          <a>iteration duration</a></code>

  If the <a>iteration start</a> is zero, the <a>start offset</a>
  is zero.

  Note: This clarification is needed since the <a>iteration duration</a>
      may be infinity and the result of infinity multiplied by zero is
      undefined according to IEEE 754-2008.

</blockquote>

The <dfn>scaled active time</dfn> is calculated according to
the following steps:

1.  If the <a>active time</a> is <code>null</code>, return
    <code>null</code>.

2.  Return the scaled active time based on the
    <a title="animation node playback rate">playback rate</a> as
    follows,

    <div class="switch">

    :   If the <a title="animation node playback rate">playback
        rate</a> is less than zero,
    ::  Return <code>(<a>active time</a> -
                    <a>active duration</a>)
        &times; <a title="animation node playback rate">playback
        rate</a>
        + <a>start offset</a></code>.

    :   If the <a title="animation node playback rate">playback
        rate</a> is zero,
    ::  Return <a>start offset</a>.

    :   Otherwise,
    ::  Return <code><a>active time</a>
        &times; <a title="animation node playback rate">playback
        rate</a> + <a>start offset</a></code>.

    </div>

<h5>Calculating the iteration time</h5>

The <dfn>iteration time</dfn> is calculated according to the
following steps:

1.  If the <a>scaled active time</a> is <code>null</code>,
    return <code>null</code>.

2.  If the <a>iteration duration</a> is zero, return zero.

3.  If <code><a>scaled active time</a> - <a>start
    offset</a></code> is equal to the <a>repeated duration</a>,
    and <a>iteration count</a> is not zero,
    and <code>(<a>iteration count</a> + <a>iteration start</a>)
    % 1</code> is zero,
    return the <a>iteration duration</a>.

4.  Otherwise, return <code><a>scaled active time</a>
    % <a>iteration duration</a></code>.
    
<h4>Calculating the current iteration</h4>

The <dfn>current iteration</dfn> can be calculated using the
following steps:

1.  If the <a>scaled active time</a> is <code>null</code>, return
    <code>null</code>.

2.  If the <a>scaled active time</a> is zero, return zero.

3.  If the <a>iteration duration</a> is zero, return
    <code>ceil(<a>iteration start</a> + <a>iteration count</a>) -
    1</code>.

4.  If the <a>iteration time</a> equals the <a>iteration
    duration</a>, return <code><a>iteration start</a>
    + <a>iteration count</a> - 1</code>.

5.  Return <code>floor(<a>scaled active time</a> /
    <a>iteration duration</a>)</code>.
    <p class="note">
      If the <a>iteration duration</a> is infinite, the
      result of <code>floor(<a>scaled active time</a> /
      <a>iteration duration</a>)</code> will be zero as defined by
      IEEE 754-2008.
    
<h3>Direction control</h3>

<a>Animation nodes</a> may also be configured to run iterations in
alternative directions using direction control.
For this purpose, <a>animation nodes</a> have a <dfn>playback
direction</dfn> parameter which takes one of the following values:

*   normal,
*   reverse,
*   alternate, or
*   alternate-reverse.

The semantics of these values are incorporated into the calculation of
the <a>directed time</a> which follows.

<div class="informative-bg"><em>This section is non-normative</em>

A non-normative definition of these values is as follows:

:   normal
::  All iterations are played as specified.

:   reverse
::  All iterations are played in the reverse direction from the way
    they are specified.

:   alternate
::  Even iterations are played as specified, odd iterations are played
    in the reverse direction from the way they are specified.

:   alternate-reverse
::  Even iterations are played in the reverse direction from the way
    they are specified, odd iterations are played as specified.

</div>

<h4>Calculating the directed time</h4>

  The <dfn>directed time</dfn> is calculated from the <a>iteration
  time</a> using the following steps:

1.  If the <a>iteration time</a> is <code>null</code>, return
    <code>null</code>.

2.  Calculate the <var>current direction</var> using the first
    matching condition from the following list:
    <div class="switch">

      :   If <a>playback direction</a> is <code>normal</code>,
      ::  Let the <var>current direction</var> be forwards.

      :   If <a>playback direction</a> is <code>reverse</code>,
      ::  Let the <var>current direction</var> be reverse.

      : Otherwise,
      ::

          1.  Let <var>d</var> be the <a>current iteration</a>.

          2.  If <a>playback direction</a> is
              <code>alternate-reverse</code> increment
              <var>d</var> by 1.

          3.  Issue: There used to be a step here which seemed to be adding
              special handling for filling when the node ends on
              a repeat boundary but it seems like that is taken care
              of by the calcuation of <a>iteration time</a> and
              <a>current iteration</a>.
              Is anything actually needed here?

          4.  If <code><var>d</var> % 2 == 0</code>, let the
              <var>current direction</var> be forwards, otherwise let
              the <var>current direction</var> be reverse.

    </div>

3.  If the <var>current direction</var> is forwards then return
    the <a>iteration time</a>.

    Otherwise, return the <a>iteration duration</a>
    - <a>iteration time</a>.

<h3>Time transformations</h3>

<h4>Scaling the time</h4>

<div class="informative-bg"><em>This section is non-normative</em>

It is often desirable to control the rate at which an <a>animation
node</a> progresses.
For example, easing the rate of animation can create a sense of
momentum and produce a more natural effect.
Conversely, in other situations such as when modelling a discrete
change, a smooth transition is undesirable and instead it is necessary
for the <a>animation node</a> to progress in a series of distinct
steps.

For such situations Web Animations provides <a>timing functions</a>
that scale the progress of an <a>animation node</a>.

<a>Timing functions</a> take an input time fraction and produce
a scaled output time fraction.

<div class="figure">
  <img src="img/timing-function-example.svg" width="350"
    alt="Example of a timing function that produces an ease-in effect.">
</div>
<p class="caption">
  Example of a timing function that produces an ease-in effect.
  Given an input timing fraction of 0.7, the timing function scales the
  value to produce an output time fraction of 0.52.<br>
  By applying this timing function, time will appear to progress more
  slowly at first but then gradually progress more quickly.
</p>

<a>Timing functions</a> are applied to an iteration of an <a>animation
node</a>.

</div>

<h4>Timing functions</h4>

A <dfn>timing function</dfn> takes an input time fraction in the range
[0, 1] and produces an output time fraction whose range is unbounded
(i.e. positive and negative infinity are permitted).

<a>Animation nodes</a> have one <a>timing function</a> associated with
them.
The default <a>timing function</a> is the <dfn>linear timing
function</dfn> whose output is identical to its input.
The <a>linear timing function</a> can be represented by the string
&ldquo;linear&rdquo;.

The range of timing functions that may be applied to a given
<a>animation node</a> depends on the type of the <a>animation node</a>.

<div class="issue">
Currently, the set of <a>timing functions</a> allowed on
an <a>animation group</a> is not restricted.
This has raised concern about complexity of implementation and also
complexity of behavior with regards to fill modes.
As a result, allowing the full set of timing functions on animation
groups is considered <strong>at risk</strong>.

Alternatives are to either restrict timing functions on animation
groups to the <a>linear timing function</a> or to a set of
&ldquo;simple&rdquo; timing functions that have properties that
alleviate some of the concerns with the more complex timing
functions.

See <a
href="http://lists.w3.org/Archives/Public/public-fx/2013JulSep/0076.html">section
2 of the discussion from August 2013</a>.
</div>

<h4>Scaling using a cubic BXXXzier curve</h4>

<div class="informative-bg"><em>This section is non-normative</em>

A common method of producing easing effects is to use a cubic BXXXier
curve to scale the time.
The endpoints of the curve are fixed at (0, 0) and (1, 1) while two
control points <var>P1</var> and <var>P2</var> define the shape of
the curve.
Provided the <var>x</var> values of <var>P1</var> and <var>P2</var>
lie within the range [0, 1] such a curve produces a function that is
used to map input times (the <var>x</var> values) onto output times
(the <var>y</var> values).
This arrangement is illustrated below.

<div class="figure">
  <img src="img/cubic-bezier-timing-curve.svg" width="500"
      alt="A cubic Bezier curve used as a timing function.">
</div>
<p class="caption">
  A cubic BXXXier curve used as a timing function.<br>
  The shape of the curve is determined by the location of the control
  points <var>P1</var> and <var>P2</var>.<br>
  Input time fractions serve as <var>x</var> values of the curve,
  whilst the <var>y</var> values are the output time fractions.
</p>

Some example cubic BXXXzier timing functions are illustrated below.

<div class="figure">
  <img src="img/curve-keywords.svg" width="500"
      alt="The timing functions produced by keyword values.">
</div>
<p class="caption">
  The timing functions produced by each of the keyword values
  associated with cubic BXXXier timing functions accepted by the
  <a href="#widl-AnimationTiming-easing"
  class="idlType"><code>AnimationTiming.easing</code></a>
  member from the <a href="#programming-interface">programming
  interface</a>.
</p>
</div>

A <dfn>cubic BXXXzier timing function</dfn> is a type of <a>timing
function</a> defined by four real numbers that specify the two control
points, <var>P1</var> and <var>P2</var>, of a cubic BXXXier curve whose
end points are fixed at (0, 0) and (1, 1).
The x coordinates of <var>P1</var> and <var>P2</var> are
restricted to the range [0, 1].

The evaluation of this curve is covered in many sources such as
[[FUND-COMP-GRAPHICS]].

A <a>cubic BXXXier timing function</a> may be specified as a string
using the following syntax (using notation from [[!CSS3-VALUES]]):
<blockquote>
  <div
    class="production"><dfn>&lt;cubic-bezier-timing-function&gt;</dfn> =
    ease | ease-in | ease-out | ease-in-out |
    <span class="atom">cubic-bezier(&lt;number&gt;, &lt;number&gt;,
      &lt;number&gt;, &lt;number&gt;)</span></div>
</blockquote>

The meaning of each value is as follows:

:   ease
::  Equivalent to cubic-bezier(0.25, 0.1, 0.25, 1).
:   ease-in
::  Equivalent to cubic-bezier(0.42, 0, 1, 1).
:   ease-out
::  Equivalent to cubic-bezier(0, 0, 0.58, 1).
:   ease-in-out
::  Equivalent to cubic-bezier(0.42, 0, 0.58, 1).
:   cubic-bezier(&lt;number&gt; &lt;number&gt; &lt;number&gt; &lt;number&gt;)
::  Specifies a <a>cubic BXXXier timing function</a>.
    The four numbers specify points <var>P1</var> and <var>P2</var> of
    the curve as (x1, y1, x2, y2).
    Both x values must be in the range [0, 1] or the definition is
    invalid.

<div class="issue">
It has been proposed to extend <code>cubic-bezier</code> to allow
multiple segments, using syntax such as the following:

<pre>
<code>cubic-bezier( [ &lt;number&gt;{6} ; ]* &lt;number&gt;{4} )</code>
</pre>

(i.e. the curve starts at (0, 0); each segment is defined by six
numbers where the start point is the end of the previous segment and
the numbers define the two control points and the end point. The
last segment is defined by four numbers since the end point is fixed
at (1, 1).)

This would provide a simple and compact syntax for tools trying to
map arbitrary curves (e.g. bounce functions) to timing functions.
</div>

<h4>Timing in discrete steps</h4>

<div class="informative-bg"><em>This section is non-normative</em>
It is possible to scale an animation node's timing so that the animation node
occurs in a series of discrete steps using a stepping function.

Some example step timing functions are illustrated below.

<div class="figure">
  <img src="img/step-timing-func-examples.svg" width="700"
      alt="Example step timing functions.">
</div>
<p class="caption">
  Example step timing functions.
  In each case the domain is the input time fraction whilst the range
  represents the output time fraction produced by the step
  function.<br>
  The first row shows the function for each transition point when only
  one step is specified whilst the second row shows the same for three
  steps.
</p>

</div>

A <dfn>step timing function</dfn> is a type of <a>timing function</a>
that divides the input time into a specified number of intervals that
are equal in duration.
The output time, starting at zero, rises by an amount equal to the
interval duration once during each interval at the transition point
which may be either the start, midpoint, or end of the interval.

In keeping with Web Animations' model of endpoint exclusive
interval timing (see <a href="#interval-timing"
section></a>), the output time at the transition point is
the time <em>after</em> applying the increase (i.e. the top of the
step) with the following exception.

When a transition point coincides with the end of the <a>active
interval</a> extra care must be taken to produce the correct result
when performing a <a title="fill mode">fill</a>.
To achieve this, when a <a>step timing function</a> is
applied to an <a>animation node</a> or applied to an <a>animation
effect</a> associated with an <a>animation node</a>, an additional
<dfn>before flag</dfn> is passed.
The value of the <a>before flag</a> is determined as follows:


1.  If the <a>active time</a> of the animation node is null, the
    <a>before flag</a> is not set and these steps should be aborted.
2.  Determine the <var>current direction</var> using the procedure
    defined in <a href="#calculating-the-directed-time"
    section></a>.
3.  If either the <var>current direction</var> is <span
    class="prop-value">forwards</span> or the <a>animation node
    playback rate</a> &ge; 0 (but <em>not</em> when both conditions
    are true),
    let <var>going forwards</var> be true, otherwise it is false.
4.  The <a>before flag</a> is set if the animation node is in the
    <a>before phase</a> and <var>going forwards</var> is true;
    or if the animation node is in the <a>after phase</a> and
    <var>going forwards</var> is false.
    
When a step timing function is evaluated at a transition point, if
the <a>before flag</a> is set the result is the value <em>before</em>
applying the increase.

A <a>step timing function</a> may be specified as a string
using the following syntax:

<blockquote>
  <div class="production"><dfn>&lt;step-timing-function&gt;</dfn> =
    step-start | step-middle | step-end |
    <span class="atom">steps(&lt;integer&gt;[,
                       [ start | middle | end ] ]?)</span></div>
</blockquote>

The meaning of each value is as follows:

:   step-start
::  Equivalent to steps(1, start);
:   step-middle
::  Equivalent to steps(1, middle);
:   step-end
::  Equivalent to steps(1, end);
:   steps(&lt;integer&gt;[, [ start | middle | end ] ]?)
::  Specifies a <a>step timing function</a>.
    The first parameter specifies the number of intervals in the
    function.
    It must be a positive integer (greater than 0).
    The second parameter, which is optional, specifies the point at
    which the change of values occur within the interval.
    If the second parameter is omitted, it is given the value <span
    class="prop-value">end</span>.

<h4>Calculating the transformed time</h4>

The <dfn>transformed time</dfn> is calculated from the
<a>directed time</a> using the following steps:

1.  If the <a>directed time</a> is <code>null</code>,
    return <code>null</code>.
2.  If the <a>iteration duration</a> is infinity,
    return the <a>directed time</a>.
3.  Let <var>iteration fraction</var> be the result of
    evaluating <code><a>directed time</a> / <a>iteration
    duration</a></code> unless <a>iteration duration</a> is
    zero, in which case let <var>iteration fraction</var> be
    zero.
4.  Let <var>scaled fraction</var> be the result of
    evaluating the <a>animation node</a>'s <a>timing function</a>
    with <var>iteration fraction</var> as the input time
    fraction.
5.  Return the result of evaluating <code><var>scaled
    fraction</var> &times; <a>iteration duration</a></code>.
    If the <var>scaled fraction</var> is zero, let the result be
    zero.

    Note: This clarification is needed since the <a>iteration duration</a>
        may be infinity and the result of infinity multiplied by zero is
        undefined according to IEEE 754-2008.


<h3>Grouping and synchronization</h3>

<div class="informative-bg"><em>This section is non-normative</em>

While it is possible to set the timing properties of <a>animation
nodes</a> individually, it is often useful to synchronize <a>animation
nodes</a> so that they share common timing properties and maintain
their temporal relationship.  This is achieved using an <a>animation
group</a>.

A simple example is illustrated below.

<div class="figure">
  <img src="img/grouping-delay.svg" width="800"
        alt="Using groups to share common timing properties.">
</div>
<p class="caption">
  Using groups to share common timing properties.<br>
  (a) Shows setting a delay of 5 seconds on individual animations.<br>
  (b) Produces the same effect by setting the delay on the group.
</p>

When an <a>animation group</a> is <a>directly associated with
a player</a>, the <a>animation nodes</a> associated with the
<a>animation group</a> can be seeked, paused, and stopped as a unit.
</p>

</div>

An <dfn>animation group</dfn> is a type of <a>animation node</a> that
contains an ordered sequence of zero or more <a>animation nodes</a>
known as <dfn title="child animation node">child animation nodes</dfn>.

At a given moment, an <a>animation node</a> may be a <a>child animation
node</a> of at most one <a>animation group</a> known as the <dfn>parent
animation group</dfn>.
The <a>parent animation group</a> cannot be the same <a>animation
node</a> as the <a>child animation node</a> itself.

By nesting <a>animation groups</a> it is possible to create hierarchical
tree structures.
The following terms are used to describe the parts and properties of
such structures and are defined in [[!DOM4]]:

*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-order">
    tree order</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-root">
    root</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-ancestor">
    ancestor</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-descendant">
    descendant</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-inclusive-ancestor">
    inclusive ancestor</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-inclusive-descendant">
    inclusive descendant</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-next-sibling">
    next sibling</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-previous-sibling">
    previous sibling</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-first-child">
    first child</a></dfn>
*   <dfn><a href="http://www.w3.org/TR/dom/#concept-tree-last-child">
    last child</a></dfn>

Note: in applying these definitions to <a>animation nodes</a>, the
    term <em>parent</em> refers exclusively to a <a>parent animation
    group</a> and does <em>not</em> include the <a>player</a> which with
    an <a>animation node</a> may be <a
    title="directly associated with a player">directly associated</a>
    despite the fact that conceptually the <a>player</a> acts as a parent
    time source.

The temporal relationship between a <a>child animation node</a> and its
<a>parent animation group</a> is incorporated in the definition of
<a>inherited time</a> (see <a href="#local-time-and-inherited-time"
section></a>).

<h4>Relationship of group time to child time</h4>

<div class="informative-bg"><em>This section is non-normative</em>

The timing of the children of an <a>animation group</a> is based on
the timing of the group.
Specifically, times for the children are based on the parent's
<a>transformed time</a>.
With regards to repetition, this means the children operate
<em>inside</em> an iteration of the parent.

For example, if an <a>animation group</a> has an <a>iteration
count</a> of 2, then the children of of the group will all play twice
since they effectively play <em>inside</em> the group's iterations.

<div class="figure">
  <img src="img/grouping-repetition.svg" width="600"
    alt="The effect of multiple iterations on the children of a group.">
</div>
<p class="caption">
  Since children of an <a>animation group</a> base their timing on the
  group's <a>transformed time</a>, when the group repeats, the
  children play again.
</p>

Note that even in this case, the child <a>animation nodes</a> still
have only <em>one</em> <a>active interval</a>.
However, as a result of the parent's timing, the <a>active
interval</a> is played twice.

If an <a>iteration count</a> is specified for the children of a group
as well as for the group itself, the effect is as if the <a>iteration
count</a> of the group was multiplied with the <a>iteration count</a>
of the children.

<div class="figure">
  <img src="img/grouping-repetition-and-animation-repetition.svg"
    width="600" alt="Iteration counts are multiplicative.">
</div>
<p class="caption">
  Specifying an <a>iteration count</a> of 2 on an <a>animation group</a>
  and an <a>iteration count</a> of 3 on one of its children results in
  that child playing 6 times.
</p>

A further result of the children of an <a>animation group</a> basing
their timing on the group's <a>transformed time</a> is that they
cannot animate outside of the group's <a>active interval</a>.
This is because the <a>transformed time</a> of a group will not
change outside its <a>active interval</a>.
This allows groups to <em>clip</em> the playback of their children.

<div class="figure">
  <img src="img/grouping-clipping.svg" width="600"
    alt="Groups clip the active interval of contained children.">
</div>
<p class="caption">
  In the first instance, an <a>animation node</a> has a negative delay
  and an infinite <a>iteration count</a>.<br>
  However, when a similar <a>animation node</a> is placed inside
  an <a>animation group</a> with a specified <a>iteration duration</a>
  it has the effect of clipping the child <a>animation node</a>'s
  <a>active interval</a>.
</p>

Some further consequences of <a>animation group</a> children basing
their timing on their parent group's <a>transformed time</a> are:

*   Setting the <a title="animation node playback rate">playback
    rate</a> of an <a>animation group</a> will speed up or slow down all
    children.

*   Changing the <a>playback direction</a> of an <a>animation group</a>
    will change the direction of all children.

*   Applying a <a>timing function</a> to an <a>animation group</a> will
    affect the progress of all children.

</div>

<h4>The start time of children of an animation group</h4>

The <a title="animation node start time">start time</a> of a <a>child
animation node</a> of an <a>animation group</a> is zero.

Note that specific types of <a>animation groups</a> may override
this definition to provide other kinds of synchronization behavior.

<h4>The intrinsic iteration duration of an animation group</h4>

The <a>intrinsic iteration duration</a> of an <a>animation
group</a> is based on the time when the last <a>child animation
node</a> completes its <a>active interval</a> and is calculated using
the following procedure.

1.  Define the <a>end time</a> of an <a>animation node</a> as:

    <blockquote>
      <dfn>end time</dfn> =
      <code><a title="animation node start time">start time</a> +
      <a>start delay</a> + <a>active duration</a> + <a>end
      delay</a></code>
    </blockquote>

2.  The <a>intrinsic iteration duration</a> depends on the number of
    <a>child animation nodes</a> as follows,
    <div class="switch">

      :   If the group has no <a>child animation nodes</a>,
      ::  the <a>intrinsic iteration duration</a> is zero.

      :   Otherwise,</dt>
      ::

          1.  Let <var>maximum end time</var> be the maximum value
              after calculating the <a>end time</a> of each <a>child
              animation node</a> in the group.</li>
          2.  The <a>intrinsic iteration duration</a> is the result of
              evaluating <code>max(0, <var>maximum end
              time</var>)</code>.</li>
    </div>

This definition of the <a>intrinsic iteration duration</a> may be
overridden by specific types of <a>animation groups</a>.

<h4>Animation sequences</h4>

<div class="informative-bg"><em>This section is non-normative</em>

Specific types of <a>animation groups</a> can be used to provide
different kinds of synchronization behavior for their children.
This specification defines one additional type of <a>animation
group</a>: an <a>animation sequence</a>.
<a>Animation sequences</a> arrange the start times of their
children so that they run one at a time, in turn.

Compare the two arrangements illustrated below:

<div class="figure">
  <img src="img/grouping-types.svg" width="600"
    alt="Animation groups and animation sequences.">
</div>
<p class="caption">
  Animation groups and animation sequences.<br>
  (a) is a regular <a>animation group</a> where all the children run
      simultaneously.<br>
  (b) is an <a>animation sequence</a> where the children run in turn.
</p>

Since <a>animation groups</a> can also contain other <a>animation
groups</a>, complex synchronization is possible by combining
different types of groups as illustrated below.

<div class="figure">
  <img src="img/grouping-nesting.svg" width="600"
    alt="Nesting of animation groups.">
</div>
<p class="caption">
  An <a>animation sequence</a> that contains a regular <a>animation
  group</a> as a child.<br>
  The <a>animation group</a> waits for the previous child of the
  <a>animation sequence</a> to finish, and then the children of the
  <a>animation group</a> play simultaneously.
  After they have finished the next child of the <a>animation
  sequence</a> plays.
</p>

</div>

An <dfn>animation sequence</dfn> is a type of <a>animation group</a>
that schedules its <a>child animation nodes</a> such that they play in
turn following their order in the group.
This sequencing is achieved by adjusting the <a
title="animation node start time">start time</a> of each <a>child
animation node</a> in the group.

<h5>The start time of children of an animation sequence</h5>

The <a title="animation node start time">start time</a> of
a <a>child animation node</a> of an <a>animation sequence</a> is the
<a>end time</a> of the child's <a>previous sibling</a>.
If the child has no <a>previous sibling</a> the start time is zero.

<div class="note">
When the <a>active duration</a> is positive infinity the behavior
for calculating the <a>end time</a> of an <a>animation node</a>
and the <a title="animation node start time">start time</a> of
subsequent children follows the usual behavior defined by IEEE
754-2008.
As a result, if any of the children of an <a>animation
sequence</a> has an infinite <a>active duration</a>, any children
that occur later in the sequence will not play.

Similarly, the above definition does not restrict
<a title="animation node start time">start times</a> to positive
values and hence some children may not play due to a negative
<a>start delay</a> on children that occur earlier in the group
since their <a>active interval</a> may end before the group's <a
title="animation node start time">start time</a>.
</div>

<div class="informative-bg"><em>This section is non-normative</em>

Because the start of the <a>active interval</a> is based on the
sum of an <a>animation node</a>'s <a
title="animation node start time">start time</a> <em>and</em>
<a>start delay</a>, the <a>active intervals</a> of
children of an <a>animation sequence</a> need not run in strict
sequence but can be shifted back and forth by using the <a>start
delay</a> as shown in the following diagram.

<div class="figure">
  <img src="img/sequence-groups-and-start-delays.svg" width="600"
    alt="Using negative start delays to overlap children of seq
        groups">
</div>
<p class="caption">
  Example of using the <a>start delay</a> on children of an
  <a>animation sequence</a> to shift their timing so that they
  overlap (a negative delay) or are spaced apart (a positive delay).
</p>

A negative <a>start delay</a> can be used to cause the <a>active
interval</a> of two children to overlap.
Note that the <a>start delay</a> affects the <a
title="animation node start time">start time</a> of subsequent
children in the group.

</div>

<h5>The intrinsic iteration duration of an animation sequence</h5>

The <a>intrinsic iteration duration</a> of an <a>animation
sequence</a> is equivalent to the <a
title="animation node start time">start time</a> of a hypothetical
<a>child animation node</a> appended to the group's children
calculated according to the definition in <a
href="#the-start-time-of-children-of-an-animation-sequence"
section></a> unless that produces a negative value, in
which case the <a>intrinsic iteration duration</a> is zero.

As a result, if the <a>animation sequence</a> has no <a>child
animation nodes</a> the <a>intrinsic iteration duration</a> will be
zero.

<h3>Animations</h3>

<dfn title="animation">Animations</dfn> are a kind of <a>animation
node</a> that apply an <a>animation effect</a> or a <a>custom effect</a>
to an element or pseudo-element such as <code>::before</code> and
<code>::first-line</code> [[!SELECT]] referred to as the <dfn>animation
target</dfn>.

<h4>Calculating the time fraction</h4>

Before passing the <a>transformed time</a> of an <a>animation</a> to
its <a>animation effect</a> it is converted to a <em>time
fraction</em>.
The <dfn>time fraction</dfn> of an <a>animation node</a> is calculated
according to the following steps:

<div class="switch">

:   If the <a>iteration duration</a> is zero,
::  the <a>time fraction</a> is as follows,

    <div class="switch">

    :   If <a>local time</a> &lt; <a>start delay</a>,
    ::  Return the result of recalculating the <a>transformed time</a>
        using an <a>iteration duration</a> of 1.

    :   Otherwise,
    ::

        1.  Let <var>normalized active duration</var> be the result of
            recalculating the <a>active duration</a> using an
            <a>iteration duration</a> of 1.
        2.  Return the result of recalculating the <a>transformed
            time</a> using a <a>local time</a> of <code><a>start
            delay</a> + <var>normalized active duration</var></code>
            and an <a>iteration duration</a> of 1.

    </div>

:   Otherwise,
::  Return <a>transformed time</a> / <a>iteration duration</a> unless
    <a>transformed time</a> is <code>null</code>, in which case return
    <code>null</code>.

</div>

Note: Since <a>timing functions</a> are allowed to produce output times
    outside the range [0, 1] it is possible that the value calculated for
    a <a>time fraction</a> also lies outside this range.

<!-- End of timing model -->



<h2>Animation Model</h2>

<div class='informative-bg'><em>This section is non-normative</em>

The Web Animations <em>animation model</em> takes the <a>time                                                                                                                    
fractions</a> and <a>current iteration</a> values produced by the                                                                                                                
<em>timing model</em> for a given <a>animation</a> and applies it as                                                                                                             
the input to the <a>animation</a>'s <a>animation effect</a>.

The output of each <a>animation effect</a> is then combined with other                                                                                                           
<a>animation effects</a> using an <a>animation stack</a> before being                                                                                                            
applied to the target properties (see <a href="#combining-animations"                                                                                                            
section></a>).

</div>

<h3>Animation effects</h3>

An <dfn>animation effect</dfn> takes a <a>time fraction</a> and
a <a>current iteration</a> value and uses them to calculate an
<a>intermediate animation value</a> for its <a
title="target property">target properties</a>.  Each <a>animation</a>
may have at most one <a>animation effect</a> associated with it.

Since the result of an <a>animation effect</a> is based on the
<a>time fraction</a> and <a>current iteration</a> value, it is updated
whenever the timing model is <a title="sampling">sampled</a>.

<h4>Target properties</h4>

Each <a>animation effect</a> can have zero or more associated
<dfn title="target property">target properties</dfn>.

<a title="target property">Target properties</a> may be CSS properties
or DOM attributes.
If a given <a>animation target</a> has an attribute with the same name
as a CSS property, any <a>target property</a> of that name is taken to
refer to to the CSS property.

Note: If there ever exists a situation where we need to animate an attribute
      with the same name as a property (other than a <a
      href="http://www.w3.org/TR/SVG2/intro.html#TermPresentationAttribute">presentation
      attribute</a> [[SVG2]]) then we will need to introduce
      a disambiguation strategy. Generally, however, such naming should be
      avoided.

<h4>Procedures for animating properties</h4>

In order to animate a <a>target property</a>, the following procedures
must be defined.

*   <dfn title="animation interpolation">interpolation</dfn> &mdash;
    given two target property values <var>V</var><sub>start</sub> and
    <var>V</var><sub>end</sub>, produces an intermediate value
    <var>V</var><sub>res</sub> at a distance of <var>p</var> along the
    interval between <var>V</var><sub>start</sub> and
    <var>V</var><sub>end</sub> such that
    <var>p</var> = 0 produces <var>V</var><sub>start</sub> and
    <var>p</var> = 1 produces <var>V</var><sub>end</sub>.
    The range of <var>p</var> is (&minus;&infin;, &infin;) due to the
    effect of <a>timing functions</a>.
    As a result, this procedure must also define extrapolation
    behavior for <var>p</var> outside [0, 1].

*   <dfn title="animation addition">addition</dfn> &mdash; given two
    target property values
    <var>V</var><sub>a</sub> and <var>V</var><sub>b</sub>, returns the
    sum of the two properties, <var>V</var><sub>result</sub>.
    For addition that is not commutative (for example, matrix
    multiplication) <var>V</var><sub>a</sub> represents the first term
    of the operation and <var>V</var><sub>b</sub> represents the
    second.

    <div class='informative-bg'><em>This section is non-normative</em>

    While <a title="animation addition">addition</a> can often be
    expressed in terms of the same weighted sum function used to
    define <a title="animation interpolation">interpolation</a>,
    this is not always the case.
    For example, interpolation of transform matrices involves
    decomposing and interpolating the matrix components whilst
    addition relies on matrix multiplication.
    
    </div>

*   <dfn title="animation accumulation">accumulation</dfn> &mdash;
    given two target property values
    <var>V</var><sub>a</sub> and <var>V</var><sub>b</sub>, returns the
    result, <var>V</var><sub>result</sub>, of combining
    the two operands such that <var>V</var><sub>b</sub> is treated as
    a <em>delta</em> from <var>V</var><sub>a</sub>.
    For accumulation that is not commutative (for example,
    accumulation of mismatched transform lists)
    <var>V</var><sub>a</sub> represents the first term of the
    operation and <var>V</var><sub>b</sub> represents the second.

    <div class='informative-bg'><em>This section is non-normative</em>

    For many types of animation such as numbers or lengths, <a
    title="animation accumulation">accumulation</a> is defined to
    be identical to <a title="animation addition">addition</a>.
    
    </div>

    A common case where the definitions differ is for list-based
    types where <a title="animation addition">addition</a> may be
    defined as appending to a list
    whilst <a title="animation accumulation">accumulation</a> may
    be defined as component-based addition.
    For example, the filter list values "blur(2)" and
    "blur(3)", when <a title="animation addition">added</a>
    together may produce "blur(2) blur(3)", but when
    <a title="animation accumulation">accumulated</a>,
    may produce "blur(5)".

*   <dfn>distance computation</dfn> &mdash; given two target property
    values <var>V</var><sub>start</sub> and
    <var>V</var><sub>end</sub>, calculates some notion of scalar
    distance between the values, <var>distance</var>.
    
<h4>Specific animation behaviors</h4>

The specific procedures used for animating a given <a>target
property</a> are referred to as the property's <dfn>animation
behavior</dfn>.

The <a>animation behavior</a> of CSS properties is defined by the
"Animatable:" line in the summary of the property's definition or in
[[CSS3-TRANSITIONS]] for properties that lack a such a line.

Issue: The default <a>animation behavior</a> for CSS properties is "as
       string".  Should this be defined here or in CSS Animations Level 4?

For DOM attributes, the <a>animation behavior</a> is defined alongside
the attribute definition.
Unlike CSS properties, if such a definition is not provided the
default <a>animation behavior</a> is &ldquo;<a>not
animatable</a>&rdquo;.

Following is a series of pre-defined <a>animation behaviors</a>.
[[CSS3-TRANSITIONS]] provides further CSS-specific <a>animation
behaviors</a>.

For <a>animation behaviors</a> that do not define a specific procedure
for <a title="animation addition">addition</a> or which are defined as
<dfn>not additive</dfn>, the <a
title="animation addition">addition procedure</a> is simply
<var>V</var><sub>res</sub> = <var>V</var><sub>b</sub>.

For <a>animation behaviors</a> that do not define a specific procedure
for <a title="animation accumulation">accumulation</a>, the <a
title="animation accumulation">accumulation procedure</a> is identical
to the <a title="animation addition">addition procedure</a> for that
behavior.

For <a>animation behaviors</a> that do not define a specific procedure
for <a>distance computation</a> or which are defined as <dfn>not
paceable</dfn>, the <a>distance computation</a> procedure is simply
<var>distance</var> = 1.

<h5>Not animatable</h5>

Some properties are specifically defined as <dfn>not
animatable</dfn>.
For example, properties defining animation parameters are <a>not
animatable</a> since doing so would create complex recursive
behavior.

Unlike other <a>animation behaviors</a>, no procedures for
<a title="animation interpolation">interpolation</a>,
<a title="animation addition">addition</a> and <a>distance
computation</a> are defined for properties whose <a>animation
behavior</a> is <a>not animatable</a> since these properties should
not be modified.

An <a>animation effect</a> that targets a property that is
<a>not animatable</a> will still exhibit the usual behavior for
an <a>animation node</a> such as occupying time in an <a>animation
sequence</a> and delaying the firing of a <a>player</a>'s <a
title="finish player event">finish event</a>.

<h5>Animatable as string</h5>

A <a>target property</a> that is <dfn>animatable as string</dfn>
has the following <a>animation behavior</a>:

*   <a title="animation interpolation">interpolation</a>:
    <div role="math" aria-describedby="math-string-interpolation"
    style="display: inline">
    <math xmlns="http://www.w3.org/1998/Math/MathML">
      <msub><mi>V</mi><mn>res</mn></msub><mo>=</mo>
      <mrow>
        <mfenced open="{" close="">
          <mtable>
            <mtr>
              <mtd columnalign="left">
                <msub><mi>V</mi><mn>start</mn></msub>
              </mtd>
              <mtd columnalign="left">
                <mtext>if&nbsp;</mtext><mi>p</mi>
                <mo>&lt;</mo><mn>0.5</mn>
              </mtd>
            </mtr>
            <mtr>
              <mtd columnalign="left">
                <msub><mi>V</mi><mn>end</mn></msub>
              </mtd>
              <mtd columnalign="left">
                <mtext>if&nbsp;</mtext><mi>p</mi>
                <mo>&ge;</mo><mn>0.5</mn>
              </mtd>
            </mtr>
          </mtable>
        </mfenced>
      </mrow>
    </math>
    <div id="math-string-interpolation">
      <var>V</var><sub>res</sub> =
        <var>V</var><sub>start</sub>, if <var>p</var> &lt; 0.5 or
        <var>V</var><sub>end</sub>, if <var>p</var> &ge; 0.5
    </div>
    </div>

<h5>Animatable as real number</h5>

A <a>target property</a> that is <dfn>animatable as real
number</dfn> has the following <a>animation behavior</a>:

*   <a title="animation interpolation">interpolation</a>:
    <var>V</var><sub>res</sub> =
      (1 - <var>p</var>) &times; <var>V</var><sub>start</sub>
      + <var>p</var> &times; <var>V</var><sub>end</sub>
*   <a title="animation addition">addition</a>:
      <var>V</var><sub>a</sub> + <var>V</var><sub>b</sub>
*   <a>distance computation</a>:
    <var>distance</var> = |<var>V</var><sub>end</sub>
                           - <var>V</var><sub>start</sub>|

<h5>Animatable as length, percentage, or calc</h5>

A <a>target property</a> that is <dfn>animatable as length,
percentage, or calc</dfn> has the following <a>animation
behavior</a>:

*   <a title="animation interpolation">interpolation</a>:
    as defined in [[CSS3-TRANSITIONS]].
*   <a title="animation addition">addition</a>:
    calc(<var>V</var><sub>a</sub> + <var>V</var><sub>b</sub>)<br>
    (Nested <code>calc()</code> functions are expanded when
    determining the computed value as defined in <a
    href="http://www.w3.org/TR/css3-values/#calc-computed-value">CSS
    Values and Units</a> [[!CSS3-VALUES]].)
*   <a>distance computation</a>: as with <a>animatable as real
    number</a> but using the <a
    href="http://www.w3.org/TR/CSS2/cascade.html#used-value">used
    value</a> [[!CSS21]] for <var>V</var><sub>start</sub> and
    <var>V</var><sub>end</sub>.

<h5>Animatable as color</h5>

A <a>target property</a> that is <dfn>animatable as color</dfn> has
the following <a>animation behavior</a>:

*   <a title="animation interpolation">interpolation</a>:
    as defined in [[CSS3-TRANSITIONS]].
*   <a title="animation addition">addition</a>:
    as with <a>animatable as real number</a> but performed on each
    RGBA color component in premultiplied space.

    Note: Since negative color is not currently supported, clamping of
          the channel values may be performed upon each addition or once
          when <a>composition</a> is complete.
    </p>
*   <a>distance computation</a>:
    <div role="math" aria-describedby="math-color-distance">
      <math xmlns="http://www.w3.org/1998/Math/MathML">
      <mrow>
        <mi>distance</mi><mo>=</mo>
        <msqrt>
          <msup>
            <mrow>
              <mfenced open="(" close=")" separators=",">
                <mrow><msub><mi>R</mi><mn>end</mn></msub>
                      <mo>-</mo>
                      <msub><mi>R</mi><mn>start</mn></msub></mrow>
              </mfenced>
            </mrow><mn>2</mn>
          </msup>
          <mo>+</mo>
          <msup>
            <mrow>
              <mfenced open="(" close=")" separators=",">
                <mrow><msub><mi>G</mi><mn>end</mn></msub>
                      <mo>-</mo>
                      <msub><mi>G</mi><mn>start</mn></msub></mrow>
              </mfenced>
            </mrow><mn>2</mn>
          </msup>
          <mo>+</mo>
          <msup>
            <mrow>
              <mfenced open="(" close=")" separators=",">
                <mrow><msub><mi>B</mi><mn>end</mn></msub>
                      <mo>-</mo>
                      <msub><mi>B</mi><mn>start</mn></msub></mrow>
                </mfenced>
            </mrow><mn>2</mn>
          </msup>
          <mo>+</mo>
          <msup>
            <mrow>
              <mfenced open="(" close=")" separators=",">
                <mrow><msub><mi>A</mi><mn>end</mn></msub>
                      <mo>-</mo>
                      <msub><mi>A</mi><mn>start</mn></msub></mrow>
              </mfenced>
            </mrow><mn>2</mn>
          </msup>
        </msqrt>
      </mrow>
      </math>

      <div id="math-color-distance">
      distance = sqrt((R<sub>end</sub> - R<sub>start</sub>)^2 + (G<sub>end</sub> - G<sub>start</sub>)^2 + (B<sub>end</sub> - B<sub>start</sub>)^2 + (A<sub>end</sub> - A<sub>start</sub>)^2)
      </div>

    </div>

    where &lt;<var>R|G|B|A</var><sub>start|end</sub>&gt;
    represents the red, green, blue, or alpha channel of
    <var>V</var><sub>start</sub> or <var>V</var><sub>end</sub>
    respectively.
    Each value is normalized to the [0.0, 1.0] range and expressed
    in premultiplied color space.
    
Issue: Should we call this &ldquo;animatable as premultiplied RGBA additive
color in sRGB color space&rdquo; instead?

<h5>Animatable as transform list</h5>

A <a>target property</a> that is <dfn>animatable as transform
list</dfn> has the following <a>animation behavior</a>:

*   <a title="animation interpolation">interpolation</a>:
    as defined in <a
    href="http://www.w3.org/TR/css3-transforms/#interpolation-of-transforms">Interpolation
    of Transforms</a> [[CSS3-TRANSFORMS]].

*   <a title="animation addition">addition</a>: performed by
    concatenating transform lists as 
    &lsquo;<var>V</var><sub>a</sub> <var>V</var><sub>b</sub>&rsquo;.

*   <a title="animation accumulation">accumulation</a>:

    1.  Beginning at the end of each list, <var>V</var><sub>a</sub>
        and <var>V</var><sub>b</sub>,
        find the largest contiguous portion of each list where the
        corresponding list elements from each list have the same
        transform type.
        Call the matching portions from <var>V</var><sub>a</sub> and
        <var>V</var><sub>b</sub>, <var>V</var><sub>matching-a</sub>
        and
        <var>V</var><sub>matching-b</sub> respectively and likewise
        <var>V</var><sub>remainder-a</sub> and
        <var>V</var><sub>remainder-b</sub> for the non-matching
        parts.
        <p class="issue">
          We should probably expand 2d functions to their 3d
          equivalents before matching?
        </p>
    2.  Let <var>V</var><sub>combined</sub> be a transform list
        combining <var>V</var><sub>matching-a</sub> and
        <var>V</var><sub>matching-b</sub> by adding the numeric
        components of each corresponding function.
        <p class="issue">
          This needs to be more specific, e.g. when combining
          <code>translate(20px)</code> and <code>translate(30px
          10px)</code> we have to expand the first function to
          <code>translate(20px 0px)</code> first.
          Probably need to define unit conversion too.
        </p>
    3.  The result of accumulation is a transform list created by <a
        title="animation addition">adding</a> the combined result
        with the non-matching portions of the two lists as follows:
        &lsquo;<var>V</var><sub>remainder-a</sub> 
        <var>V</var><sub>remainder-b</sub>
        <var>V</var><sub>combined</sub>&rsquo;.

*   <a>distance computation</a>: <span class="todo">See issue
    below</span>

<div class="issue">

    For <a>distance computation</a> we previously defined it as follows:
    
    1.  Look only at the first component of the two lists
    2.  If both are translate &rarr; euclidean distance
    3.  If both are scale &rarr; absolute difference
    4.  If both are rotate &rarr; absolute difference
    5.  If both match but are something else &rarr; use linear
    6.  If they don't match &rarr; use matrix decomposition and
        euclidean distance between translate components
    
    This seems really arbitrary, especially part 5.
    
    Also, looking at only the first component seems odd.
    Going through each component, working out the distance and then
    getting the square of the distance also seems much more consistent
    with what we do elsewhere.

</div>

<h5>Other animation behaviors</h5>

The set of <a>animation behaviors</a> defined here may be extended
by other specifications.
For example, properties with using the &lt;image&gt; type are
animated using the interpolation behavior defined in <a
href="http://dev.w3.org/csswg/css-images-4/#interpolation">CSS Image
Values and Replaced Content</a>
[[CSS4-IMAGES]].

<div class="issue">

    There are a bunch of CSS properties for which distance (and in
    some cases addition) is not defined or which need special
    handling.
    
    For example,
    
    *   font-stretch (an enum but handled like an integer)
    *   visibility (0 or 1 depending on if endpoints match or not)
    *   flex-grow and flex-shrink which allow animation only if one of
        the endpoints is 0)
    *   value pairs, triples (use square distance)
    *   rects (use square distance)
    *   dash arrays (square distance but a bit weird due to
        percentages)
    *   shadows (square distance of components)
    *   filters (undefined)
    *   background-position (special list handling needed)
    *   pair lists
    
    Should we define these here or in the CSS Animation 4 spec?

</div>

<h4>Intermediate animation values</h4>

Given a <a>time fraction</a>, a <a>current iteration</a>, and an
<a>underlying value</a>, an <a>animation effect</a> produces
an <dfn>intermediate animation value</dfn> for each <a>animatable</a>
<a>target property</a>.
The procedure for calculating this value depends on the specific
type of <a>animation effect</a> and is defined subsequently (see <a
href="#the-intermediate-animation-value-of-a-keyframe-animation-effect"
section></a> and <a
href="#the-intermediate-animation-value-of-a-motion-path-animation-effect"
section></a>).

Before being applied to the <a title="target property">target
properties</a>,
these <a>intermediate animation values</a> are composed together using
the process defined in <a href="#combining-animations" section></a>.

<h3>Combining animations</h3>
<div class='informative-bg'><em>This section is non-normative</em>

After calculating the <a>intermediate animation values</a> for an
<a>animation effect</a>, they are applied to the <a>animation
effect</a>'s <a title="target property">target properties</a>.

Since it is possible for multiple <a>in effect</a> <a
title="animation">animations</a> to target the same property it is
often necessary to combine the results of several <a>animation
effects</a> together.
This process is called <em>compositing</em> and is based on
establishing an <a>animation stack</a> for each property targetted by
an <a>in effect</a> <a>animation effect</a>.

After compositing the results of <a>animation
effects</a> together, the composited result is combined with other
values specified for the <a>target property</a>.

For a CSS <a>target property</a> the arrangement is illustrated below:

<div class="figure">
<img src="img/animation-cascade.svg" width="450"
alt="Overview of the application of intermediate animation values
to their target properties">
</div>
<p class="caption">
Overview of the application of <a>intermediate animation values</a> to
their <a>target properties</a>.<br>
The results of <a>animation effects</a> targetting the same property
are composited together using an <a>animation stack</a>.<br>
The result of this composition is written to an animation stylesheet
that is more important than other stylesheets but less than any
<code>!important</code> rules.
</p>

For a <a>target property</a> that specifies a DOM attribute, the
composited result is combined with the value of the attribute
specified in the DOM or the lacuna value for that attribute if it is
not specified.

For the first part of this operation&mdash;combining <a>intermediate
animation values</a> that target the same <a
title="target property">property</a>&mdash; it is necessary to
determine both
<em>how</em> the <a>animation effects</a>
associated with the <a>animations</a> are combined
with one another,
as well as the <em>order</em> in which they are applied, that is,
their relative <em>priority</em>.

The matter of <em>how</em> <a>intermediate animation values</a> are
combined is governed by the <a>composite operation</a> of
the corresponding <a>animation effects</a>.
The relative <em>priority</em> of <a>intermediate animation values</a>
is determined by an <a>animation stack</a> established for each
animated property.
</div>

<h4>The animation stack</h4>

Associated with each property <a title="target property">targetted</a>
by one or more <a>animation effects</a> is an <dfn>animation
stack</dfn> that establishes the relative priority of the <a>animation
effects</a>.

The relative priority of any two <a>animation
effects</a>, <var>A</var> and <var>B</var>, within an <a>animation
stack</a> is established by comparing the properties of the
<a>animations</a> applying <var>A</var> and <var>B</var> as follows:

1.  Let the <dfn>associated player of an animation effect</dfn>
    be the <a>player</a> <a
    title="associated with a player">associated</a> with the
    <a>animation</a> that is applying the <a>animation effect</a> to
    the property with which this <a>animation stack</a> is
    associated.
2.  Sort <var>A</var> and <var>B</var> by applying the following
    conditions in turn until the order is resolved,
    
    1.  Sort <var>A</var> and <var>B</var> using any <a>custom
        player priority</a> specified for the <a
        title="associated player of an animation effect">associated
        player</a> of each of <var>A</var> and
        <var>B</var> so that lower priorities sort first.
    2.  Sort by the <a>player sequence number</a> so that lower
        sequence numbers sort first.
    3.  Sort <var>A</var> and <var>B</var> in <a>tree order</a>.
        (By this point, <var>A</var> and <var>B</var> must have the
        same <a>player</a> since otherwise the order would have been
        resolved in the previous step.)

<a>Animation effects</a> that sort earlier have <em>lower</em>
priority.

<h5>The custom player priority</h5>

Each <a>player</a> has an associated numeric <dfn>custom player
priority</dfn> that is used to provide high-level control of
animation priority for specifications layered on top of Web
Animations.
The initial value of the <a>custom player priority</a> is zero.

<div class="note">
Note: the <a>custom player priority</a> is primarily
    intended to be used to prioritize animations at
    a high-level, such as to prioritize animations <em>by type</em>.
    For example, it can be used to ensure that CSS Animations always
    override CSS Transitions.

    It is possible to control animation priority at a lower-level by
    setting the <a>player start time</a> appropriately,
    (possibly after making compensatory adjustments to the <a>start
    delay</a> of the <a>source content</a>) or influencing the
    <a>player sequence number</a> by controlling when <a>players</a>
    are created.
</div>

<h4>Calculating the result of an animation stack</h4>

In order to calculate the final value of an <a>animation stack</a>,
the <a>intermediate animation values</a> of each
<a>animation effect</a> in the stack are combined in order of priority
from lowest to highest priority.

Each step in the process of evaluating an <a>animation stack</a> takes
an <dfn>underlying value</dfn> as input.

For each <a>animation effect</a> in the stack, the appropriate
<a>intermediate animation value</a> from the <a>animation effect</a>
is combined with the <a>underlying value</a> to produce a new value.
This resulting value becomes the <a>underlying value</a> for combining
the next <a>animation effect</a> in the stack.

The final value of an <a>animation stack</a>, called the
<dfn>composited value</dfn>, is simply the result of combining the
<a>intermediate animation value</a> of the final (highest priority)
<a>animation effect</a> in the stack with the <a>underlying value</a>
at that point.

<h4>Animation composition</h4>

The specific operation used to combine an <a>intermediate animation
value</a> with an <a>underlying value</a> is determined by the
<dfn>composite operation</dfn> of the <a>animation effect</a> that
produced the <a>intermediate animation value</a>.

This specification defines three <a>composite operations</a> as
follows:

:   <dfn title="composite operation replace">replace</dfn>
::  The result of compositing the <a>intermediate animation value</a>
    with the <a>underlying value</a> is simply the <a>intermediate
    animation value</a>.
:   <dfn title="composite operation add">add</dfn>
::  The <a>intermediate animation value</a> is <a
    title="animation addition">added</a> to the <a>underlying
    value</a>.
    For <a>animation behaviors</a> where the
    <a title="animation addition">addition operation</a> is defined
    such that it is not commutative, the order of the operands is
    <code><a>underlying value</a> + <a>intermediate animation
    value</a></code>.
:   <dfn title="composite operation accumulate">accumulate</dfn></dt>
::  The <a>intermediate animation value</a> is <a
    title="animation accumulation">accumulated</a>
    onto the <a>underlying value</a>.
    For <a>animation behaviours</a> where the
    <a title="animation accumulation">accumulation operation</a> is
    defined such that it is not commutative, the order of the operands
    is <a>underlying value</a> followed by <a>intermediate animation
    value</a>.

<h4>Applying the composited result</h4>

The process for a applying a <a>composited value</a> depends on if the
<a>target property</a> refers to a CSS property or a DOM attribute.

<h5>Applying the result to a CSS property</h5>

Applying a <a>composited value</a> to a CSS <a>target property</a>
depends on establishing an <a>animation stylesheet</a>.

The <dfn>animation stylesheet</dfn> contains
<a title="composited value">composited animation values</a>
and acts with a higher priority than all other stylesheets.
However, <code>!important</code> rules from all other stylesheets
act with a higher priority than the <a>animation stylesheet</a>.
The <a>animation stylesheet</a> is regenerated each time the
<a>animation model</a> is updated (see <a href="#animation-effects"
section></a>).

The <a>composited value</a> calculated for a CSS <a>target
property</a> is applied using the following process.

1.  Calculate the <var>base value</var> of the property as
    the value generated for that property by computing the <a
    href="http://www.w3.org/TR/CSS2/cascade.html#used-value">used
    value</a> [[!CSS21]] for that property in the absence of the
    <a>animation stylesheet</a>.
2.  Establish the <a>animation stack</a> for the property (see <a
    href="#the-animation-stack" section></a>).
3.  Calculate the <a>composited value</a> of the <a>animation
    stack</a> passing in the <var>base value</var> of the property
    as the initial <a>underlying value</a> (see <a
    href="#calculating-the-result-of-an-animation-stack"
    section"></a>).
4.  Insert the <a>composited value</a> into the <a>animation
    stylesheet</a>.

<h5>Applying the composited result to a DOM attribute</h5>

DOM attributes are, unless otherwise specified, <a>not
animatable</a>.
For each attribute that has a specific <a>animation behavior</a>
associated with it, an attribute value to use when the attribute is
not specified or in error must be defined, referred to as the
<dfn>lacuna value</dfn>.
For example, SVG2 ([[SVG2]]) defines <a
href="http://www.w3.org/TR/SVG2/intro.html#TermLacunaValue">lacunae
values</a> for its attributes.

The <a>composited value</a> calculated for a DOM attribute <a>target
property</a> is applied using the following process.

1.  Let the <var>base value</var> of the property be the value
    specified for attribute in the DOM or,
    if the attribute value is not specified in the DOM, the
    <a>lacuna value</a> for that attribute.
2.  Establish the <a>animation stack</a> for the property (see <a
    href="#the-animation-stack" section></a>).</li>
3.  Calculate the <a>composited value</a> of the <a>animation
    stack</a> passing in the <var>base value</var> of the attribute
    as the initial <a>underlying value</a> (see <a
    href="#calculating-the-result-of-an-animation-stack"
    section></a>).</li>
4.  Record the <a>composited value</a> as the <dfn>animated
    attribute value</dfn> of the attribute.

The <a>animated attribute value</a> does not replace the value of
the attribute in the DOM although it may be accessible via some
other interface.
For all intents and purposes other than interaction with DOM
interfaces, user agents must treat the <a>animated attribute
value</a> as the attribute value.

<h4>Animation accumulation</h4>

Similar to the compositing performed between <a>intermediate animation
values</a> (see <a href="#animation-composition"
section></a>), the <dfn>iteration composite operation</dfn>
determines how values are combined between successive iterations of
the same <a>animation</a>.

This specification defines two <a>iteration composite operations</a>
as follows:

:   <dfn title="iteration composite operation replace">replace</dfn>
::  Each successive iteration is calculated independently of previous
    iterations.
:   <dfn title="iteration composite operation accumulate">accumulate
::  Successive iterations of the animation are <a
    title="animation accumulation">accumulated</a> with the
    final value of the previous iteration.

    The application of the <a>iteration composite operation</a> is
    incorporated in the calculation of the <a>intermediate animation
    value</a> for each type of <a>animation effect</a>.

<h3>Keyframe animation effects</h3>

A <dfn>keyframe animation effect</dfn> is an <a>animation effect</a>
that produces <a>intermediate animation values</a> for its <a>target
properties</a> by interpolating between a series of property values
positioned at fractional offsets.

Each set of property values indexed by an offset is called
a <dfn>keyframe</dfn>.

The <dfn title="keyframe offset">offset of a keyframe</dfn> is a value
in the range [0, 1] or the special value null.
The list of <a>keyframes</a> for a <a>keyframe animation effect</a> is
<dfn>loosely sorted by offset</dfn> which means that for each
<a>keyframe</a> in the list that has a <a>keyframe offset</a> that is
not null, the offset is greater than or equal to the offset of the
previous <a>keyframe</a> in the list with a <a>keyframe offset</a> that
is not null, if any.

The behavior when <a>keyframes</a> overlap or have unsupported values
is defined in <a
href="#the-intermediate-animation-value-of-a-keyframe-animation-effect"
section></a>.

Each keyframe also has a <a>timing function</a> associated with it
that is applied to the period of time between the keyframe on which it
is specified and the <em>next</em> keyframe in the list.
The <a>timing function</a> specified on the last keyframe in the
list is never applied.

In addition to the <a>composite operation</a> specified on the
<a>animation effect</a>, each <a>keyframe</a> may also have an
associated <a>composite operation</a> that is applied to all values
specified in that <a>keyframe</a>.
If no <a>composite operation</a> is specified for a <a>keyframe</a>,
the <a>composite operation</a> specified for the <a>animation
effect</a> is used.

<h4>Spacing keyframes</h4>
<div class="informative">

It is often useful to be able to provide a series of property values
without having calculate the <a>keyframe offset</a> of each value in
time but instead to rely on some automatic spacing.

For example, rather than typing:

<pre class='example sh_javascript'>
elem.animate([ { color: 'blue', offset: 0 },
               { color: 'green', offset: 1/3 },
               { color: 'red', offset: 2/3 },
               { color: 'yellow', offset: 1 } ], 2000);
</pre>

It should be possible to type the following and allow the user agent
to calculate the <a title="keyframe offset">offset</a> of each
keyframe:

<pre class='example sh_javascript'>
elem.animate([ { color: 'blue' },
               { color: 'green' },
               { color: 'red' },
               { color: 'yellow' } ], 2000);
</pre>

Web Animations provides spacing modes for this purpose. The default
spacing mode for keyframe animation effects is
&ldquo;<a
title="distribute keyframe spacing mode">distribute</a>&rdquo; which
produces the result described above.

The other spacing mode, &ldquo;<a
title="paced keyframe spacing mode">paced</a>&rdquo;, is useful when
it is desirable to maintain an even rate of change such as for <a
href="#motion-path-animation-effects">motion path animation</a>.

For example, consider the following animation:

<pre class='example sh_javascript'>
elem.animate([ { left: '0px' },
               { left: '-20px' },
               { left: '100px' },
               { left: '50px' } ], 1000);
</pre>

The resulting value of the <span class="prop-name">left</span>
property is illustrated below:

<div class="figure">
<img src="img/spacing-distribute.svg" width="350"
     alt="The animated value of the left property over time when applying the distribute spacing mode.
The values are evenly spaced in time but the rate of change differs for each segment as indicated the varying slope of the graph.">
</div>
<p class="caption">
The animated value of the left property over time when applying the
<a title="distribute keyframe spacing mode">distribute</a> spacing
mode.
The values are evenly spaced in time but the rate of change differs
for each segment as indicated the varying slope of the graph.
</p>

We can use the <a title="paced keyframe spacing mode">paced</a>
spacing mode as follows:

<pre class='example sh_javascript'>
elem.animate(
  new KeyframeEffect([ { left: '0px' },
                       { left: '-20px' },
                       { left: '100px' },
                       { left: '50px' } ], { spacing: "paced" }), 1000);
</pre>

The result is illustrated below:

<div class="figure">
<img src="img/spacing-paced.svg" width="350"
     alt="The animated value of the left property over time when applying the paced spacing mode.
The absolute value of the slope is graph is equal for all segments of the animation indicating a constant rate of change.">
</div>
<p class="caption">
The animated value of the left property over time when applying the
<a title="paced keyframe spacing mode">paced</a> spacing mode.
The absolute value of the slope is graph is equal for all segments
of the animation indicating a constant rate of change.
</p>

It is also possible to combine fixed <a>keyframe offsets</a> with
spacing modes as follows:

<pre class='example sh_javascript'>
elem.animate(
  new KeyframeEffect([ { left: '0px' },
                       { left: '-20px' },
                       { left: '100px', offset: 0.5 },
                       { left: '50px' } ], { spacing: "paced" }), 1000);
</pre>

The result is illustrated below:

<div class="figure">
<img src="img/spacing-paced-with-offset.svg" width="350"
     alt="The animated value of the left property over time when applying the paced spacing mode and a fixed offset that puts the 100px value at 0.5.
The slope of the graph is equal for the first two segments but changes for the last segment in order to accommodate the fixed offset.">
</div>
<p class="caption">
The animated value of the left property over time when applying the
<a title="paced keyframe spacing mode">paced</a> spacing mode and
a fixed <a>keyframe offset</a> that
puts the 100px value at 0.5.
The slope of the graph is equal for the first two segments but
changes for the last segment in order to accommodate the fixed
offset.
</p>
</div>

Before calculating animation values from a <a>keyframe animation
effect</a>, an absolute value must be computed for the <a>keyframe
offset</a> of each <a>keyframe</a> with a null offset.
The values computed depend on the <dfn>keyframe spacing mode</dfn>
specified for the <a>keyframe animation effect</a>.
The keyframe spacing modes are:

:   <dfn title="distribute keyframe spacing mode">distribute</dfn></dt>
::  Indicates that <a>keyframes</a> with a null <a>keyframe offset</a>
    null are positioned so that the difference between subsequent
    <a>keyframe offsets</a> are equal.
:   <dfn title="paced keyframe spacing mode">paced</dfn></dt>
::  Indicates that <a>keyframes</a> with a null <a>keyframe offset</a>
    null are positioned so that the <em>distance</em> between subsequent
    values of a specified <dfn>paced property</dfn> are equal.
    The distance is calculated using the <a>distance computation</a>
    procedure defined by the <a>animation behavior</a> associated
    with the <a>paced property</a>.

<h5>Applying spacing to keyframes</h5>

We define a generic procedure for <dfn>evenly distributing
a keyframe</dfn>, <var>keyframe</var>, between two reference
keyframes, <var>start</var> and <var>end</var>, whose <a>keyframe
offsets</a> are <em>not</em> null, as follows:

1.  Let <dfn>offset<sub><var>k</var></sub></dfn> be the <a>keyframe
    offset</a> of a <a>keyframe</a> <var>k</var>.
2.  Let <var>n</var> be the number of keyframes <em>between</em> and
    including <var>start</var> and <var>end</var> minus 1.
3.  Let <var>index</var> refer to the position of
    <var>keyframe</var> in the sequence of keyframes between
    <var>start</var> and <var>end</var> such that the first keyframe
    after <var>start</var> has an <var>index</var> of 1.
4.  Set the <a>keyframe offset</a> of <var>keyframe</var> to
    <a title="offsetk">offset</a><sub><var>start</var></sub> +
    (<a title="offsetk">offset</a><sub><var>end</var></sub> &minus;
     <a title="offsetk">offset</a><sub><var>start</var></sub>)
    &times; <var>index</var> / <var>n</var>.

The computed <a>keyframe offset</a> values of each <a>keyframe</a>
with a null keyframe offset are determined using the following
procedure.

1.  Let <var>keyframes</var> refer to the list of <a>keyframes</a>
    associated with the <a>keyframe animation effect</a>.
2.  If <var>keyframes</var> contains more than one
    <a>keyframe</a> and the <a>keyframe offset</a> of
    the first <a>keyframe</a> in <var>keyframes</var> is null,
    set the <a>keyframe offset</a> of
    the first <a>keyframe</a> to 0.
3.  If the <a>keyframe offset</a> of the last <a>keyframe</a> in
    <var>distributed keyframes</var> is null, set its
    <a>keyframe offset</a> to 1.
4.  For each pair of <a>keyframes</a> <var>A</var> and <var>B</var>
    where:

    1.  <var>A</var> appears before <var>B</var> in
        <var>keyframes</var>, and
    2.  <var>A</var> and <var>B</var> have a <a>keyframe
        offset</a> that is not null, and
    3.  all <a>keyframes</a> between <var>A</var> and <var>B</var>
        have a null <a>keyframe offset</a>,
          
    calculate the <a>keyframe offset</a> of
    each <a>keyframe</a> between <var>A</var> and <var>B</var>
    depending on the <a>keyframe spacing mode</a> as follows:

    <div class="switch">
    
    :   If the <a title="keyframe spacing mode">spacing mode</a>
        is <a title="paced keyframe spacing mode">paced</a>,</dt>
    ::
        
        1.  Define a keyframe as <dfn>paceable</dfn> if it
            contains a value for the <a>paced property</a>.
        2.  Let <var>paced A</var> be the first keyframe in the
            range [<var>A</var>, <var>B</var>] that is
            <a>paceable</a>, if any.
        3.  Let <var>paced B</var> be the last keyframe in the
            range [<var>A</var>, <var>B</var>] that is
            <a>paceable</a>, if any.
        4.  If there is no <var>paced A</var> or <var>paced
            B</var> let both refer to <var>B</var>.
            <!-- FIXME: I want to mark this up as an inline note but
                 currently respec's CSS for notes doesn't play
                 will with inlines. -->
            <span>Note that in this case, the spacing
            behavior degenerates to <a
            title="distribute keyframe spacing mode">distribute</a>
            spacing.
        5.  For each keyframe in the range
            (<var>A</var>, <var>paced A</var>] and
            [<var>paced B</var>, <var>B</var>),
            apply the procedure for <a>evenly distributing
            a keyframe</a> using <var>A</var> and <var>B</var> as
            the <var>start</var> and <var>end</var> keyframes
            respectively.
            
            <div class="annotation">
            Yes, this is correct.
            We want, <var>index</var> and <var>n</var> in that
            procedure to reflect <em>all</em> the keyframes
            between <var>A</var> and <var>B</var>, not just the
            keyframes between, for example, <var>A</var> and
            <var>spaced A</var>.
            </div>

        6.  For each keyframe in the range
            (<var>paced A</var>, <var>paced B</var>) that is
            <a>paceable</a>:

            1.  Let
                <dfn title="distk">dist<sub><var>k</var></sub></dfn>
                represent the cumulative distance to a keyframe
                <var>k</var> from <var>paced A</var>
                as calculated by applying the <a>distance
                computation</a> defined by the <a>animation
                behavior</a> of the <a>paced property</a> to the
                values of the <a>paced property</a> on each pair of
                successive <a>paceable</a> keyframes in the range
                [<var>paced A</var>, <var>k</var>].
            2.  Set the offset of <var>k</var> to
                <a title="offsetk">offset</a><sub><var>paced
                  A</var></sub>
                +
                (<a title="offsetk">offset</a><sub><var>paced
                  B</var></sub>
                &minus; 
                <a title="offsetk">offset</a><sub><var>paced
                  A</var></sub>)
                &times;
                <a title="distk">dist</a><sub><var>k</var></sub>
                /
                <a title="distk">dist</a><sub><var>paced
                  B</var></sub>
        7.  For each keyframe in the range (<var>paced A</var>,
            <var>paced B</var>) that still has
            a null <a>keyframe offset</a> (because it is not
            <a>paceable</a>), apply the procedure
            for <a>evenly distributing a keyframe</a> using
            the nearest <a>keyframe</a> before and after the
            keyframe in question in <var>keyframes</var> that has
            a <a>keyframe offset</a> that is not null, as the
            <var>start</var> and <var>end</var> keyframes
            respectively.
    :   Otherwise,</dt>
    ::  Apply the procedure for <a>evenly distributing
        a keyframe</a> to each keyframe in the range (<var>A</var>,
        <var>B</var>) using <var>A</var> and <var>B</var> as the
        <var>start</var> and <var>end</var> keyframes respectively.
    
    </div>

Note: although the above procedure defines computing keyframe
    offsets in terms of overwriting null values, user agents that
    implement the <a href="#programming-interface">programming
    interface</a> are required to maintain the original null values as
    well as calculating the computed offsets.
    This is because the <code>getFrames</code> method of the
    <a>KeyframeEffect</a> interface returns keyframe offsets both
    before and after applying spacing.

Issue: The above algorithm is quite complex.
    It attempts to cover all possible combinations of input where
    keyframe offsets and or paced property values may be missing.
    Furthermore, it attempts to do this in a way that degenerates
    consistently and also allows the author to combine fixed offsets
    with either pacing or distribute spacing.
    We await implementation experience to determine if the complexity
    is justified.

<h4>The intermediate animation value of a keyframe animation effect</h4>

The <a>intermediate animation value</a> of a single property
referenced by a <a>keyframe animation effect</a> as one of its
<a title="target property">target properties</a>, for a given
<var>time fraction</var>, <var>current iteration</var> and
<var>underlying value</var> is calculated as follows.

1.  Let <var>target property</var> be the property for which the
    <a>intermediate animation value</a> is to be calculated.
2.  If <a>animation behavior</a> of the <var>target property</var> is
    <a>not animatable</a> abort this procedure since the effect cannot
    be applied.
3.  Define the <dfn>neutral value for composition</dfn> as a value
    which, when combined with an <a>underlying value</a> using the <a
    title="composite operation add">add</a> <a>composite
    operation</a>, produces the <a>underlying value</a>.
4.  Let <var>property-specific keyframes</var> be a copy of the list
    of <a>keyframes</a> specified on the effect.
5.  Remove any <a>keyframes</a> from <var>property-specific
    keyframes</var> that do not have a property value for
    <var>target property</var>.
6.  If <var>property-specific keyframes</var> is empty, return
    <var>underlying value</var>.
7.  If there is no <a>keyframe</a> in <var>property-specific
    keyframes</var> with a <a>keyframe offset</a> of
    0, create a new <a>keyframe</a> with a <a>keyframe offset</a> of
    0, a property value set to the <a>neutral value for
    composition</a>, and a <a>composite operation</a> of <a
    title="composite operation add">add</a>, and prepend it to the
    beginning of <var>property-specific keyframes</var>.
8.  Similarly, if there is no <a>keyframe</a> in
    <var>property-specific keyframes</var> with a <a>keyframe
    offset</a> of 1,
    create a new <a>keyframe</a> with a <a>keyframe offset</a> of 1,
    a property value set to the <a>neutral value for composition</a>,
    and a <a>composite operation</a> of <a
    title="composite operation add">add</a>, and append it to the
    end of <var>property-specific keyframes</var>.
9.  Let <var>interval endpoints</var> be an empty sequence of
    keyframes.
10. Populate <var>interval points</var> by following the steps from
    the first matching condition from below:

    <div class="switch">
    
    :   If <var>time fraction</var> &lt; 0 and there is more
        than one <a>keyframe</a> in <var>property-specific
        keyframes</var> with a <a>keyframe offset</a> of
        0,
    ::  Add the first <a>keyframe</a> in <var>property-specific
        keyframes</var> to <var>interval endpoints</var>.
    :   If <var>time fraction</var> &ge; 1 and there is more
        than one <a>keyframe</a> in <var>property-specific
        keyframes</var> with a <a>keyframe offset</a> of
        1,
    ::  Add the last <a>keyframe</a> in <var>property-specific
        keyframes</var> to <var>interval endpoints</var>.
    :   Otherwise,
    ::
    
        1.  Append to <var>interval endpoints</var> the last
            <a>keyframe</a> in <var>property-specific
            keyframes</var> whose <a>keyframe offset</a> is less than
            or equal to <var>time fraction</var> and less than 1.  If
            there is no such <a>keyframe</a> (because, for example,
            the <a>time fraction</a> is negative), add the last
            <a>keyframe</a> whose <a>keyframe offset</a> is 0.
        2.  Append to <var>interval endpoints</var> the next
            <a>keyframe</a> in <var>property-specific keyframes</var>
            after the one added in the previous step.
            
    </div>

11. For each <var>keyframe</var> in <var>interval endpoints</var>:

    1.  If <var>keyframe</var> has a <a>composite operation</a>
        that is <em>not</em> <a
        title="composite operation replace">replace</a>, or
        <var>keyframe</var> has no <a>composite operation</a>
        and the <a>composite operation</a> of this <a>keyframe
        animation effect</a> is <em>not</em> <a
        title="composite operation replace">replace</a>, then
        perform the following steps:
        
        1.  Let <var>composite operation to use</var> be the
            <a>composite operation</a> of <var>keyframe</var>, or if
            it has none, the <a>composite operation</a> of this
            <a>keyframe animation effect</a>.
        2.  Let <var>value to combine</var> be the property value of
            <var>target property</var> specified on
            <var>keyframe</var>.
        3.  Replace the property value of <var>target property</var>
            on <var>keyframe</var> with the result of combining
            <var>underlying value</var> (<var>V</var><sub>a</sub>) and
            <var>value to combine</var> (<var>V</var><sub>b</sub>)
            using the <var>composite operation to use</var>
            procedure defined by the <var>target property</var>'s
            <a>animation behavior</a>.
            
    2.  If this <a>keyframe animation effect</a> has an <a>iteration
        composite operation</a> of <a
        title="iteration composite operation accumulate">accumulate</a>,
        apply the following step <var>current iteration</var> times:
        
        *   replace the property value of <var>target property</var>
            on <var>keyframe</var> with the result of combining the
            property value (<var>V</var><sub>a</sub>) with the
            property value on the final keyframe in
            <var>property-specific keyframes</var>
            (<var>V</var><sub>b</sub>) using the <a
            title="animation accumulation">accumulation procedure</a>
            defined for <var>target property</var>.
            
        Issue: It seems like this could be done as a separate step at the end
            and applied to all types of animation effects consistently.
            
12. If there is only one keyframe in <var>interval endpoints</var>
    return the property value of <var>target property</var> on that
    keyframe.
13. Let <var>start offset</var> be the <a>keyframe offset</a> of the
    first keyframe in <var>interval endpoints</var>.
14. Let <var>end offset</var> be the <a>keyframe offset</a> of
    last keyframe in <var>interval endpoints</var>.
15. Let <var>interval distance</var> be the result of evaluating
    <code>(<var>time fraction</var> - <var>start offset</var>) /
    (<var>end offset</var> - <var>start offset</var>)</code>
16. Return the result of applying the <a 
    title="animation interpolation">interpolation procedure</a> defined
    by the <a>animation behavior</a> of the <var>target property</var>,
    to the values of the <var>target property</var> specified on the
    two keyframes in <var>interval endpoints</var> taking the first such
    value as <var>V</var><sub>start</sub> and the second as
    <var>V</var><sub>end</sub> and using <var>interval
    distance</var> as the interpolation parameter <var>p</var>.

<div class="note">
    Note that this procedure assumes the following about the list of
    <a>keyframes</a> specified on the effect:</p>

    *   Each <a>keyframe</a> has a specified <a>keyframe offset</a> in
        the range [0, 1].
    *   The list of <a>keyframes</a> is sorted in ascending order by
        <a>keyframe offset</a>.
    *   Each specified property value is a valid and supported value.
    *   For a given property, there is a most one specified property
        value on each keyframe.

    It is the responsibility of the user of the model (for example,
    a declarative markup or programming interface) to ensure these
    conditions are met.

    For example, for the <a href="#programming-interface">programming
    interface</a> defined by this specification, these conditions are
    met by applying the normalization defined in <a
    href="#normalizing-a-sequence-of-keyframes" section></a>
    and resolving <code>null</code> <a>keyframe offsets</a> by
    applying <a href="#spacing-keyframes">spacing behavior</a>.
</div>

Note: this procedure permits overlapping <a>keyframes</a>.
    The behavior is that at the point of overlap the output value jumps to
    the value of the last defined <a>keyframe</a> at that offset.
    For overlapping frames at 0 or 1, the output value for <a
    title="time fraction">time fractions</a> less than 0 or greater than
    or equal to 1 is the value of the first <a>keyframe</a> or the last
    <a>keyframe</a> in <var>keyframes</var> respectively.

<div class="issue">
    In the presence of certain timing functions, the input time
    fraction to an animation effect is not limited to the range [0, 1].
    Currently, however, keyframe offsets <em>are</em> limited to the
    range [0, 1] and property values are simply extrapolated for input
    time fractions outside this range.

    We have considered removing this restriction since some cases exist
    where it is useful to be able to specify non-linear
    changes in property values at time fractions outside the range
    [0, 1].
    One example is an animation that interpolates from green to yellow
    but has an overshoot timing function that makes it temporarily
    interpolate &lsquo;beyond&rsquo; yellow to red before settling back
    to yellow.

    While this effect could be achieved by modification of the keyframes
    and timing function, this approach seems to break the model's
    separation of timing concerns from animation effects.

    It is not clear how this effect should be achieved but we note that
    allowing keyframe offsets outside [0, 1] may make the currently
    specified behavior where keyframes at offset 0 and 1 are synthesized
    as necessary, inconsistent.

    See <a
    href='http://lists.w3.org/Archives/Public/public-fx/2013AprJun/0184.html'>section
    4 (Keyframe offsets outside [0, 1]) of minuted discussion from Tokyo
      2013 F2F</a>.
</div>

<h3>Motion path animation effects</h3>

A <dfn>motion path animation effect</dfn> is an <a>animation effect</a>
that produces <a>animation values</a> for the transform <a>target
property</a> of an <a>animation target</a> such that it follows
a geometric curve commonly referred to as a &ldquo;motion path&rdquo;.

The <dfn>motion path</dfn> of a <a>motion path animation effect</a> is
defined by an SVG Path, as specified by SVG [[!SVG2]].
A <a>motion path</a> consists of a list of <dfn
title="path command">path commands</dfn> (see <a
href="http://www.w3.org/TR/SVG2/paths.html#PathData">path data</a>
[[!SVG2]]).

Amongst the different types of path commands, we define
<dfn title="orientation path command">orientation path commands</dfn> as
<a
href="http://www.w3.org/TR/SVG2/paths.html#PathDataMovetoCommands">moveto</a>
commands and <a
href="http://www.w3.org/TR/SVG2/paths.html#PathDataBearingCommands">bearing</a>
commands.
All types of path commands that are <em>not</em> <a>orientation
path commands</a> are referred to as <dfn
title="drawing path command">drawing path commands</dfn>.

The <dfn>automatic rotation flag</dfn> of a <a>motion path animation
effect</a>, if set, specifies that the <a>intermediate animation
value</a> generated by the <a>motion path animation effect</a> produces
a rotation that matches the directional tangent vector of the
<a>motion path</a>.

The <dfn>rotation angle</dfn> parameter of a <a>motion path animation
effect</a> specifies a constant rotation that applies to the target
transform in addition to any rotation generated by setting the
<a>automatic rotation flag</a>.

<h4>Distance along a path</h4>

The procedure used for calculating the length of a path or
a subsection is provided by the definition of <a
href="http://www.w3.org/TR/SVG2/paths.html#DistanceAlongAPath"><dfn>distance
along a path</dfn></a> in SVG [[!SVG2]].

<h4>Spacing motion paths</h4>

The following properties control the rate of progress of a <a>motion
path animation effect</a>:

:   <dfn title="motion path spacing mode">spacing mode</dfn>
::  Specifies the strategy used for determining the offset of each
    <a>spacing point</a> or <a>path command</a> when not specified by
    a <a>point offset</a>.
    The possible spacing modes are identical to those defined for
    <a>keyframe animation effects</a> (see <a
    href="#spacing-keyframes" section></a>).

    Note that a spacing mode of <a
    title="distribute keyframe spacing mode">distribute</a> has no
    effect if <a>point offsets</a> are specified.
    This is because spacing <em>between</em> <a>point offsets</a>
    always uses <a title="paced keyframe spacing mode">paced</a>
    spacing mode.
:   <dfn title="spacing point">spacing points</dfn>
::  An optional sequence of real numbers in the range [0.0, 1.0] that
    correspond to fractions of the total path length.
    The animation effect produces animation values such that the
    <a>animation target</a> moves backwards and forwards along the
    <a>motion path</a> following the sequence indicated by these
    points.

    Furthermore, the point on the <a>motion path</a> indicated by each
    such number forms a handle that may be associated with a <a>point
    offset</a> or positioned by the <a
    title="motion path spacing mode">spacing mode</a>.
:   <dfn title="point offset">point offsets</dfn>
::  An optional ordered sequence of real numbers in the range [0.0,
    1.0] that specifies the <a>time fraction</a> when the
    corresponding <a>spacing point</a>, or, if <a>spacing points</a>
    are not provided, <a>drawing path command</a>, should be visited.

    If specified, the first value in the sequence must be 0.0 and the
    last value must be 1.0.
    There must be as many items in the sequence of <a>point
    offsets</a> as in the sequence of <a>spacing points</a>, if
    provided.
    If a sequence of <a>spacing points</a> is not provided,
    the number of items in <a>point offsets</a> must equal the number
    of <a>drawing path commands</a> in the <a>motion path</a> plus
    one.
:   <dfn title="point easing">point easing</dfn>
::  An optional ordered sequence of <a>timing functions</a> that
    specify the easing behavior between each pair of <a>spacing
    points</a>, or, if <a>spacing points</a> are not provided, between
    each pair of <a>drawing path commands</a>.

    If specified, there must be as many items as in
    the sequence of <a>spacing points</a> minus one, if provided.
    If a sequence of <a>spacing points</a> is not provided,
    the number of items in <a>point easing</a> must equal the number
    of <a>drawing path commands</a> in the <a>motion path</a>.

Note: the above descriptions of the length of each list
    represent the requirements of the model.
    Users of the model such as markup or programming interfaces
    may fulfil these requirements, for example, by defining padding
    behavior or error handling.

Issue: Need a diagram here showing how the different combinations work.

<h5>Applying spacing to motion paths</h5>

The end result of applying spacing is:

*   a sequence of <a>effective spacing points</a>,
*   a sequence of <a>effective point offsets</a>, and
*   a sequence of <a>effective point easing</a>
    <a>timing functions</a>.

The sequence of <dfn>effective spacing points</dfn> is determined by
following the steps associated with the first matching condition
from below:

<div class="switch">

:   If there are no <a>drawing path commands</a>,
::  Let <a>effective spacing points</a> be an empty sequence.
:   If <a>spacing points</a> is specified,
::  Let <a>effective spacing points</a> refer to <a>spacing
    points</a>.
:   Otherwise,</dt>
::  Perform the following steps:

    1.  Let <a>effective spacing points</a> be a sequence
        consisting of the single element 0.
    2.  For each <a>drawing path command</a> in <a>path
        commands</a>, append to <a>effective spacing points</a>
        a number equal to the <a>distance along a path</a> up to
        the point at the end of the given <a>path command</a>,
        divided by the total path length.

</div>

Having determined the <a>effective spacing points</a>, the sequence
of <dfn>effective point offsets</dfn> is determined by following the
steps associated with the first matching condition from below:

<div class="switch">

:   If there are no <a>drawing path commands</a>,
::  Let <a>effective point offsets</a> be an empty sequence.
:   If point offsets is specified,
::  Let <a>effective point offsets</a> refer to <a>point
    offsets</a>.
:   If the <a title="motion path spacing mode">spacing mode</a>
    is <a title="distribute spacing mode">distribute</a>,
::  Perform the following steps:

    1.  Let <a>effective point offsets</a> be a sequence of
        equal length to <a>effective spacing points</a>.
    2.  Let <var>n</var> be the number of elements in
        <a>effective point offsets</a> minus one.
    3.  Let <var>k</var> represent an index in the range [0,
        <var>n</var>].
    4.  Set the value of each point in <a>effective point
        offsets</a> so that the point at index <var>k</var>
        is equal to <var>k</var> / <var>n</var>.
        
:   Otherwise,
::  Perform the following steps:

    1.  Let <a>effective point offsets</a> be a sequence of
        equal length to <a>effective spacing points</a>.
    2.  Let <var>n</var> be the number of elements in
        <a>effective point offsets</a> minus one.
    3.  Let <var>k</var> represent an index in the range [0,
        <var>n</var>].
    4.  Let <dfn title="pointk">point(<var>k</var>)</dfn>
        represent the value of <a>effective spacing points</a>
        at index <var>k</var>.
    5.  Set the value of each point in <var>effective point
        offsets</var> so that the value at index <var>k</var> is
        defined by the following formula:
        
        *   For <var>k</var> = 0, <var>offset</var> = 0
        *   For <var>k</var> = 1..<var>n</var>,
            <var>offset</var> =
            <div role="math"
              aria-describedby="math-pacing-points"
              style="display: inline">
              <math xmlns="http://www.w3.org/1998/Math/MathML">
              <mrow>
                <mfrac>
                  <mrow>
                    <munderover>
                        <mo>&#x3A3;</mo>
                        <mrow>
                          <mi>i</mi>
                          <mo>=</mo>
                          <mn>1</mn>
                        </mrow>
                          <mi>k</mi>
                    </munderover>
                    <mfenced open="|" close="|" separators=",">
                      <mrow>
                        <mi>point</mi><mo>&ApplyFunction;</mo>
                        <mfenced open="(" close=")" separators=",">
                          <mrow>
                            <mi>i</mi>
                          </mrow>
                        </mfenced>
                        <mo>-</mo>
                        <mi>point</mi><mo>&ApplyFunction;</mo>
                        <mfenced open="(" close=")" separators=",">
                          <mrow>
                            <mi>i</mi>
                            <mo>-</mo>
                            <mn>1</mn>
                          </mrow>
                        </mfenced>
                      </mrow>
                    </mfenced>
                  </mrow> 
                  <mrow>
                    <munderover>
                        <mo>&#x3A3;</mo>
                        <mrow>
                          <mi>i</mi>
                          <mo>=</mo>
                          <mn>1</mn>
                        </mrow>
                          <mi>n</mi>
                    </munderover>
                    <mfenced open="|" close="|" separators=",">
                      <mrow>
                        <mi>point</mi><mo>&ApplyFunction;</mo>
                        <mfenced open="(" close=")" separators=",">
                          <mrow>
                            <mi>i</mi>
                          </mrow>
                        </mfenced>
                        <mo>-</mo>
                        <mi>point</mi><mo>&ApplyFunction;</mo>
                        <mfenced open="(" close=")" separators=",">
                          <mrow>
                            <mi>i</mi>
                            <mo>-</mo>
                            <mn>1</mn>
                          </mrow>
                        </mfenced>
                      </mrow>
                    </mfenced>
                  </mrow>
                </mfrac>
              </mrow>
              </math>
              <div id="math-pacing-points">
                [ \sum_{i=1}^k | point(i)-point(i-1) | ]
                /
                [ \sum_{i=1}^n | point(i)-point(i-1) | ]
              </div>
            </div>

    Note: When <a>effective spacing points</a> is a sequence of
        monotonically increasing points beginning with 0 and ending
        with 1 (or, in fact, any time the sum of distances between
        <a>effective spacing points</a> is equal to&nbsp;1),
        <a>effective point offsets</a> will mirror <a>effective
        spacing points</a>.

</div>

The <dfn>effective point easing</dfn> is simply the specified
<a>point easing</a>.
If <a>point easing</a> is not set, the <a>effective point easing</a>
is a sequence of <a>linear timing functions</a> equal in length to
the number of <a>drawing path commands</a> in the <a>motion
path</a>.

<h4>Determining the path fraction</h4>

The <dfn>path fraction</dfn> for a given <a>time fraction</a>,
<var>progress</var>, is determined using the following procedure:

1.  If <a>effective point offsets</a> is empty, let <a>path
    fraction</a> equal <a>time fraction</a> and abort these steps.
2.  If <a>effective point offsets</a> has only one item, let <a>path
    fraction</a> equal the value of the one item in <a>effective
    spacing points</a> and abort these steps.

    Note: <a>Effective point offsets</a> can only have one item if
        <a>spacing points</a> has exactly one item. In this case, the
        <a>effective points offsets</a> will always be a list containing
        just the value 0.

3.  If <var>progress</var> &ge; 1, let the <a>path fraction</a> equal
    the value of the <em>last</em> item in <a>effective point
    offsets</a> and abort these steps.
4.  If <var>progress</var> &lt; 0, let the <a>path fraction</a> equal
    the value of the <em>first</em> item in <a>effective point
    offsets</a> and abort these steps.
5.  Let <var>start index</var> and <var>end index</var> represent
    the zero-based indices of the <em>last</em> pair of successive
    values in <var>effective point offsets</var> such that <var>start
    offset</var> &le; <var>progress</var> &le; <var>end offset</var>.
6.  Let <var>interval fraction</var> be the ratio of the difference
    between <var>progress</var> and the offset at <var>start
    index</var>, and the difference between the offset at <var>end
    index</var> and the offset at <var>start index</var>.
7.  Let <var>scaled interval fraction</var> be the result of applying
    the <a>timing function</a> from <a>effective point easing</a>
    at index <var>start index</var> with <var>interval fraction</var>
    as the input.
8.  Let <var>segment start</var> and <var>segment end</var> be the
    values in <a>effective spacing points</a> at the indicies
    <var>start index</var> and <var>end index</var> respectively.
9.  Let the <a>path fraction</a> be the result of evaluating the
    following formula:
    <code><var>scaled interval fraction</var> *
    (<var>segment end</var> - <var>segment start</var>) +
    <var>segment start</var></code>.

<h4>The intermediate animation value of a motion path animation effect</h4>

The <a>intermediate animation value</a> of a <a>motion path animation
effect</a> for a given <var>time fraction</var>, <var>current
iteration</var>, and <var>underlying value</var> is given by the
following process:

1.  Let <var>distance</var> be the <a>path fraction</a> for the given
    <a>time fraction</a>.
2.  Let <var>displacement</var> be the point located
    <var>distance</var> along the <a>motion path</a> using the
    definition for <a>distance along a path</a>.

    If <var>distance</var> indicates a point on the path that is
    coincidental with one or more <a>orientation path
    commands</a>, <var>displacement</var> is the point
    <em>after</em> all <a>orientation path commands</a> (this will
    be the <em>start</em> of the next <a>drawing path command</a> if
    there is one).
3.  Let the <var>translation component</var> be the translation
    transform required to transform the point at the start of
    <a>motion path</a> to <var>displacement</var>.
4.  Calculate the <var>rotation component</var> according to the
    first match condition from the following:
    
    <div class="switch">
    
    :   If the <a>automatic rotation flag</a> is set,
    ::  the <var>rotation component</var> is a transform representing
        the sum of:
        
        *   the angle of the tangent vector at
            <var>displacement</var>, and
        *   the <a>rotation angle</a>.

    :  Otherwise,
    ::  the <var>rotation component</var> is a transform representing
        the <a>rotation angle</a>.
      
    </div>

    When calculating the angle of the tangent vector, if there are
    no <a>drawing path commands</a> in the <a>motion path</a>, the
    the angle should be taken to be zero.

    <div class="issue">

        The original text for this section contained the following
        qualifications but I'm not sure how meaningful they are:

        *   For continuous <a>path commands</a> (all elements except
            moveto), the angle of the tangent vector for the purpose of
            these calculations is defined to be an integer multiple of
            2&pi; different from the value given by <a
            href="http://en.wikipedia.org/wiki/Tangential_angle">standard
            mathematical formulae for tangents to curves in
            2 dimensional space</a>.
        *   For moveto <a>path commands</a>, which are discontinuous, the
            angle of the tangent vector for the purpose of these
            calculations is always an integer multiple of 2&pi;.
        *   The initial value of the angle of the tangent vector is
            computed using the first element of the curve, and is always
            in the range [0, 2&pi;).
        *   Single continuous path commands must never produce tangent
            vector angles that are discontinuous over their defined
            region. This implies that a single unique solution is
            available for all points on continuous path commands.
        *   When computing angles after discontinuous or non-smooth
            jumps, multiple possible solutions may be available.  These
            solutions will differ by integer multiples of 2&pi;.  In
            such cases the solution that lies closest to the previous
            tangent angle is used.
            
    </div>
    
5.  Let the <var>transform value</var> be the result of
    by constructing a transform list consisting of the
    <var>translation component</var> followed by the <var>rotation
    component</var>.
    
    Issue: What's the value in keeping these separate?
        Shouldn't we collapse them?

6.  Let the <var>unaccumulated value</var> be the result of
    combining the <var>underlying value</var> (<var>V</var><sub>a</sub>)
    with the <var>transform value</var> (<var>V</var><sub>b</sub>)
    using the <a>composite operation</a> of the effect.
7.  Let the <var>intermediate animation value</var> be
    <var>unaccumulated value</var>.
8.  If the <a>iteration composite operation</a> of this <a>motion path
    animation effect</a> is <a
    title="iteration composite operation accumulate">accumulate</a>,
    perform the following steps:

    1.  Let the <var>final transform value</var> be the value
        calculated for the <var>transform value</var> when performing
        the first five steps of this procedure using a <var>time
        fraction</var> of 1.
    2.  Perform the following step <var>current iteration</var> times:
    
        *   Set the <var>intermediate animation value</var> to the
            result of combining the current value of
            <var>intermediate animation value</var>
            (<var>V</var><sub>a</sub>) with
            <var>final transform value</var>
            (<var>V</var><sub>b</sub>)
            using the <a title="animation accumulation">accumulation
            procedure</a> defined by the
            <a>animatable as transform list</a> <a>animation
            behavior</a>.

9.  Return the <var>intermediate animation value</var>.

Issue: Need to describe how <a
    href="http://www.w3.org/TR/css3-transforms/#transform-origin-property">transform-origin</a>
    is applied.
    
<h3>Custom effects</h3>

<div class='informative-bg'><em>This section is non-normative</em>

In some situations the <a>animation
effects</a> provided by Web Animations may be insufficient.
For example, the <a>animation effects</a>
defined here are only able to target certain CSS properties.
They are unable, therefore, to modify the <a
href="http://www.w3.org/TR/SVG11/struct.html#__svg__SVGSVGElement__currentScale"><code>currentScale</code></a>
property of an SVG element to smoothly zoom the viewport without
affecting the document content.

In such cases, where the provided <a>animation
effects</a> do not provide needed functionality, an effect defined by
script may be used.
Such <a>custom effects</a> receive a <a>time
fraction</a> and <a>current iteration</a> from the timing model and
are responsible for producing an effect corresponding to the specified
time.

Using an effect defined in script it is possible to animate not only
otherwise un-animatable attributes and properties, but potentially
anything that is accessible via script, including even producing audio
or creating vibrations.

For example, using a <a>custom effect</a> that draws to a <a
href="http://www.w3.org/TR/html5/scripting-1.html#the-canvas-element"><code>canvas</code></a>
element, it is possible to produce a complex animated effect
featuring patterns that may be difficult to create using CSS or
SVG.
Compared to using <a
href="http://www.w3.org/TR/animation-timing/">Timing control for
script-based animations</a>,
this approach ensures the animation is frame-rate
independent and can be paused, reversed, eased with timing effects,
accelerated, synchronized with other animations, and be controlled
in the same manner as any other Web Animations animation without any
additional programming.

</div>

A <dfn>custom effect</dfn> is an author-defined programming callback
that is passed timing information when <a>sampling</a> is performed.

<h4>Sampling custom effects</h4>

<a>Custom effects</a> are called for each referencing <a>animation</a>
when a <a>sample</a> is performed based on the following criteria.

1.  If, on the previous sample, the <a>animation</a> referencing the
    <a>custom effect</a>:
    
    *   was <a>in effect</a>, and
    *   referenced this same <a>custom effect</a>, and
    *   had a different <a>animation target</a>
    
    Call the callback passing a null <a>time fraction</a> and the
    <a>animation target</a> from the previous sample as parameters to
    the callback.
2.  Call the callback for the current <a>animation target</a> based on
    the first matching condition from the following:
    
    <div class="switch">

    :   If the <a>animation</a> referencing the custom effect is not
        <a>in effect</a> but was <a>in effect</a> in the previous
        sample,
    ::  Call the callback passing a null <a>time fraction</a> and the
        current <a>animation target</a> as parameters to the callback.
    :   Otherwise, if the <a>animation</a> referencing the custom
        effect:
    ::

        *   <strong>is <a>in effect</a>, and</strong>
        *   <strong>was not <a>in effect</a> in the previous <a>sample</a>, or
              was <a>in effect</a> but with a different <a>time
              fraction</a> or <a>current iteration</a>,</strong>

    ::   Call the callback passing with the referencing
        <a>animation</a>'s current <a>time fraction</a> and <a>animation
        target</a> as parameters to the callback.

    </div>

<div class="issue">
There may be use cases where an action needs to be triggered at
a specific point in an animation tree.
In many cases this can be achieved by inserting a custom effect with
a step-start easing that spans the period during which the action
should be triggered.
However, this can impose additional layout requirements on the
content which might be cumbersome to accomodate.

Some alternatives under consideration:

*   Additional calling conditions could be defined to accommodate
    zero-width custom effects. For example, it could be required
    that the callback be called if (given infinite precision) there
    was a time between the previous and current sample times that
    aligned with the custom effect.
*   Instead of adding special calling conditions to custom effects,
    a new type of animation node, Trigger, could be introduced. The
    trigger would only ever act as a zero-width custom effect as
    described above, its constructor would take a callback function,
    but not require a target or timing. It could also specify other
    calling conventions, for example whether it should only trigger
    in a specific playback direction.

</div>

<h4>Execution order of custom effects</h4>

Since <a>custom effects</a>, unlike <a
title="animation effect">animation effects</a>, are not limited to
a single <a>target property</a>, the steps for assessing their
order of execution differs from <a>animation effects</a>.f

<a>Custom effects</a> are executed after all
<a>animation effects</a> have completed and
applied their result to their targets (see <a
href="#applying-the-composited-result" section></a>).

Issue: Need to define this more precisely.
    Are styles flushed?
    Presumably they are.
    Can we suspend reflow for the duration of executing the script-based
    animation effects and just do it once afterwards?

Within the set of <a>custom effects</a>, the
order of execution is the same as that defined for <a title="animation
effect">animation effects</a> in <a href="#the-animation-stack" section></a>.
Items sorted earlier are executed before those sorted later.

<!-- End of animation model -->

<h2>Programming interface</h2>

<div class='informative-bg'><em>This section is non-normative</em>

In addition to the abstract model described above, Web Animations also
defines a programming interface to the model.
This interface can be used to inspect and extend animations produced
by declarative means or for directly producing animations when
a procedural approach is more suitable.

</div>

<h3>The <code>AnimationTimeline</code> interface</h3>

<a>Timelines</a>, including the <a>document
timeline</a> are represented in the Web Animations API by the
<a>AnimationTimeline</a> interface.
        
<pre class="idl">
interface AnimationTimeline {
    readonly attribute double? currentTime;
    AnimationPlayer           play (optional AnimationNode? source = null);
    sequence&lt;AnimationPlayer&gt; getAnimationPlayers ();
};
</pre>

<div class='attributes'>

:   <dfn attribute for=AnimationTimeline>currentTime</dfn>
    <span attribute-info for=AnimationTimeline/currentTime></span>
::  Returns the <a>time value</a> for this timeline or <code>null</code>
    if this timeline is <a>not started</a>.

</div>

<div class='methods'>

:   <dfn method for=AnimationTimeline title='play()'>
    AnimationPlayer play(optional TimedItem? source = null)</dfn>
::  Creates a new <a interface>AnimationPlayer</a> object associated with
    this <a>timeline</a> that is scheduled to start at <code>currentTime</code>.

    The <code>timeline</code> attribute of the newly-created
    <a>AnimationPlayer</a> object will be set to this object.

    Similarly, the <code>startTime</code> attribute will be set to the
    value of this object's <code>currentTime</code> attribute at the
    moment the method was called, or, if <code>currentTime</code> is
    <code>null</code>, zero.</li>

    The <code>currentTime</code> attribute of the
    <a>AnimationPlayer</a> object is a calculated value described in
    <a href="#the-current-time-of-a-player" section></a>.

    The <code>playbackRate</code> and <code>paused</code> attributes
    take on their default values as described in the definitions of
    the <a title="player playback rate">playback rate</a> and
    <a>paused state</a> properties of <a>player</a> objects.

    The <a for=AnimationPlayer>source</a>
    attribute of the created <a>AnimationPlayer</a>
    is set from the <em>source</em> parameter by following the
    procedure defined for updating that attribute.
    As a result, if <em>source</em> is already associated with
    a <code>player</code>, it will be disassociated first before
    being associated with the new <a>AnimationPlayer</a>.

    <div class='parameters'>

    :   source
    ::  the <a>source content</a> to assign to the newly-created
        <a>AnimationPlayer</a> object.

    </div>
    
:   <dfn method for=AnimationTimeline title='getAnimationPlayers()'>
    sequence&lt;AnimationPlayer&gt; getAnimationPlayers()</dfn>
::  Returns the set of <a>AnimationPlayer</a> objects
    associated with this <a>timeline</a> that have associated
    <a>source content</a> which is <a>current</a>.

    The returned list is sorted in increasing order by <a>player
    sequence number</a>.

<h3>The <code>AnimationPlayer</code> interface</h3>

<a>Players</a> are represented in the Web Animations
API by the <a>AnimationPlayer</a> interface.

<pre class='idl'>
interface AnimationPlayer : EventTarget {
             attribute AnimationNode?    source;
    readonly attribute AnimationTimeline timeline;
             attribute double            startTime;
             attribute double            currentTime;
             attribute double            playbackRate;
    readonly attribute boolean           paused;
    readonly attribute boolean           finished;
    void cancel ();
    void finish ();
    void play ();
    void pause ();
    void reverse ();

    // Event callbacks
             attribute EventHandler      onfinish;
};
</pre>

<div class='attributes'>

:   <dfn attribute for=AnimationPlayer>source</dfn>
	<span attribute-info for=source></span>
::  The <a>source content</a> associated with this player.

    A <a>player</a> can only be associated with at most one
    <a>animation node</a>, and likewise, an <a>animation node</a> can
    only be <a title="associated with a player">associated</a> with at
    most one <a>player</a>.
    In order to maintain these invariants, on setting this value, the
    following procedure is performed:

    1.  Let <var>old value</var> be the current value of the
        <code>source</code> attribute.
    2.  Let <var>new value</var> be the value to set.
    3.  If <var>new value</var> is the same object as <var>old
        value</var>, return.
	4.  If <var>old value</var> is not <code>null</code>,
		disassociate <var>old value</var> from this player.
	5.  If <var>new value</var> is not <code>null</code>,
        perform the steps associated with the first matching condition
        of the following:

		<div class='switch'>

        :   If <var>new value</var> has no parent group and is
            associated with a player,
        ::  disassociate <var>new value</var> from its player.
        :   If <var>new value</var> has a parent group,
        ::	remove <var>new value</var> from its parent group by
            calling <code><var>new value</var>.remove()</code>.
        :	Otherwise,
        ::	do nothing.

		</div>

    6.	Associate <var>new value</var> with this player.
    7.	Set the <code>source</code> attribute to <var>new
        value</var>.
        
:	<dfn attribute for=AnimationPlayer>timeline</dfn>
	<span attribute-info for=timeline></span>
::	The <a>timeline</a> associated with this player.
:	<dfn attribute for=AnimationPlayer>startTime</dfn>
	<span attribute-info for=startTime></span>
::  Returns the <a title="player start time">start time</a> of this
	player.
	Setting this attribute updates the <a>player start time</a> using
	the procedure defined in <a href="#updating-the-player-start-time" section></a>
:	<dfn attribute for=AnimationPlayer>currentTime</dfn>
	<span attribute-info for=AnimationPlayer/currentTime></span>
::  The <a>effective current time</a> of this player.
	Setting this attribute follows the procedure defined in 
	<a href="#performing-a-seek" section></a>.   
:   <dfn attribute for=AnimationPlayer>playbackRate</dfn>
	<span attribute-info for=playbackRate></span>
::  The <a title="player playback rate">playback rate</a> of this
	player.
	Setting this attribute follows the procedure defined in <a
	href="#updating-the-playback-rate" section></a>.
:	<dfn attribute for=AnimationPlayer>paused</dfn>
	<span attribute-info for=paused></span>
::  The <a>paused state</a> of this player.
:   <dfn attribute for=AnimationPlayer>finished</dfn>
	<span attribute-info for=finished></span>
::  Returns true if this <a>player</a> has reached or passed the end of
	its <a>source content</a> in its current <a>playback direction</a>.
	This corresponds to when the player is <a>limited</a>.
:	<dfn attribute for=AnimationPlayer>onfinish</dfn>
	<span attribute-info for=onfinish></span>
::	The event handler for the <a title="finish player event">finish</a> event.
            
    Note: the <a
		href="http://www.w3.org/TR/html5/webappapis.html#eventhandler">EventHandler</a>
        callback interface type is defined in [[!HTML5]].

</div>

<div class='methods'>

:   <dfn method for=AnimationPlayer title='cancel()'>void cancel()</dfn>
::	Sets <code>source</code> to null and clears all effects associated
    with the previous <a>source content</a>.

    Issue: We need to make sure, for example, that any custom effects get
		called with a null sample time so they can remove their effects.
        This applies to manually setting <code>source</code> to null as
        well so we should define this behavior there.
          
:   <dfn method for=AnimationPlayer title='finish()'>void finish()</dfn>    
::  Seeks the player to the end of the <a>source content</a> in the
	current direction as follows:
	
	<div class='switch'>

    :	If <a>player playback rate</a> &lt; zero,
    ::	<a href="#performing-a-seek">Seek</a> the player so its
        <a>current time</a> is zero.
	:	If <a>player playback rate</a> equals zero,
    ::	Do nothing.
    :	If <a>player playback rate</a> &gt; zero,
    ::	<a href="#performing-a-seek">Seek</a> the player so its
        <a>current time</a> is equal to the <a>end time</a> of the
		<a>source content</a> or zero if there is no <a>source
		content</a> associated with this player..
    
    </div>
           
	<div class='exceptions'>

	:	DOMException of type <code>InvalidStateError</code>
    ::	Raised if the <a>end time</a> of this player's <a>source
        content</a> is infinity and the <a>player playback rate</a> is
        &gt; zero.

	</div>
	
:   <dfn method for=AnimationPlayer title='play()'>void play()</dfn>
::	Unpauses the player and rewinds if it has finished playing using
    the following procedure:

    1.	Set the <a>paused state</a> of the player to false using the
        procedure defined in <a href="#updating-the-paused-state" section></a>
    2.	If <a>source content</a> is associated with the player,
		<a href="#performing-a-seek">adjust the current time</a> of
        the player as follows:
        
		<div class="switch">
        
        :	If <a>player playback rate</a> &gt; 0; and
            either <a>current time</a> &lt; zero or
            <a>current time</a> &ge; <a>source
            content</a>'s <a>end time</a>,
        ::	Seek to time zero.
        :	If <a>player playback rate</a> &lt; 0; and
            either <a>current time</a> &le; zero or
            <a>current time</a> &gt; <a>source
            content</a>'s <a>end time</a>,
        ::	Seek to the <a>source content</a>'s <a>end
            time</a>.
        :	Otherwise,
        ::	Do nothing.

		</div>

    3.	Set the player's <a>finished flag</a> to false.

:	<dfn method for=AnimationPlayer title='pause()'>void pause()</dfn>
::	Set the <a>paused state</a> of this player to true using the
    procedure defined in <a href="#updating-the-paused-state" section></a>.
:	<dfn method for=AnimationPlayer title='reverse()'>void reverse()</dfn>
::	Inverts the <a title="player playback rate">playback rate</a> of
	this player and seeks to the start of the source media if it has
	finished playing in the reversed direction using the following
    procedure.

    1.	If the <a>player playback rate</a> is zero, abort these steps.
	2.	If <a>source content</a> is associated with the player,
        <a href="#performing-a-seek">adjust the current time</a> of
        the player as follows:

        <div class="switch">

        :	If <a>player playback rate</a> &gt; zero and
            <a>effective current time</a> &gt; <a>source
            content</a>'s <a>end time</a>,
		::	Seek to the <a>source content</a>'s <a>end time</a>.
        :	If <a>player playback rate</a> &lt; zero and
            <a>effective current time</a> &lt; zero,
        ::	Seek to time zero.
        :	Otherwise,
        ::	Do nothing.

		</div>

    3.	Set the <a>player playback rate</a> to <code>-<a>player
            playback rate</a></code> following the steps in <a
            href="#updating-the-playback-rate" section></a>.
    4.	Set the <a>paused state</a> of the <a>player</a> to false.
        
		Issue: Is this unpausing behavior correct?

        Note: unlike <code>play()</code>, the player's <a>finished
            flag</a> is not explicitly reset here since that behavior is
            performed by the procedure for updating the <a>player playback
            rate</a> defined in <a href="#updating-the-playback-rate" section></a>.

</div>

<h3>The <code>AnimationNode</code> interface</h3>

<a>Animation nodes</a> are represented in the Web
Animations API by the <a>AnimationNode</a> interface.

<pre class='idl'>
interface AnimationNode {
    // Timing
    readonly attribute AnimationTiming         timing;
    readonly attribute ComputedAnimationTiming computedTiming;

    // Timing hierarchy
    readonly attribute AnimationGroup?         parent;
    readonly attribute AnimationNode?          previousSibling;
    readonly attribute AnimationNode?          nextSibling;
    void before (AnimationNode... nodes);
    void after (AnimationNode... nodes);
    void replace (AnimationNode... nodes);
    void remove ();

    // Associated player
    readonly attribute AnimationPlayer?        player;
};
</pre>

<div class='attributes'>

:	<dfn attribute for=AnimationNode>timing</dfn>
	<span attribute-info for=timing></span>
::	Returns the input timing properties specified for this
    <a>animation node</a>.
    This is comparable to the specified style on an Element,
    <code>elem.style</code>.
:	<dfn attribute for=AnimationNode>computedTiming</dfn>
	<span attribute-info for=computedTiming></span>
::	Returns the calculated timing properties for this <a>animation
    node</a>.
    This is comparable to the computed style of an Element,
    <code>window.getComputedStyle(elem)</code>.
              
	Although several of the attributes of the this object are common
    to the <code>timing</code> <a>AnimationTiming</a> object they
    have the following differences:

	*	<code>duration</code> &ndash; returns the calculated value of
        the <a>iteration duration</a>. If <code>timing.duration</code>
        is the string <code>auto</code> or any unsupported value, this
        attribute will return the current calculated value of the
        <a>intrinsic iteration duration</a>.
    *	<code>fill</code> &ndash; the <code>auto</code> value is
		replaced with the specific <a>FillMode</a> depending on the type
        of <a>animation node</a> (see <a
        href="#the-fillmode-enumeration" section></a>).
    *	<code>easing</code> &ndash; unrecognised or unsupported values
        are replaced with the string <code>linear</code>.

:   <dfn attribute for=AnimationNode>parent</dfn>
	<span attribute-info for=parent></span>
::  The <a>parent animation group</a> of this <a>animation node</a> or
    <code>null</code> if this <a>animation node</a> does not have
    a <a>parent animation group</a>.

    Issue: Should this be <code>parentGroup</code>?

:	<dfn attribute for=AnimationNode>previousSibling</dfn>
	<span attribute-info for=previousSibling></span>
::	The <a>previous sibling</a> of this <a>animation node</a>.
:	<dfn attribute for=AnimationNode>nextSibling</dfn>
	<span attribute-info for=nextSibling></span>
::	The <a>next sibling</a> of this <a>animation node</a>.
:	<dfn attribute for=AnimationNode>player</dfn>
	<span attribute-info for=player></span>
::	The <a>player</a> with which this animation node is <a
    title="associated with a player">associated</a>, if any.
    This object can be used to perform play control such as pausing or
    rewinding on this <a>animation node</a> <em>and all other
    animation nodes in the same hierarchy</em>.
    
	This will be <code>null</code> if this <a>animation node</a> is
    not <a>associated with a player</a>.

    Issue: Feedback has been provided that suggests this reference causes the
        relationship between AnimationPlayers and AnimationNodes to be
        circular, which confuses the model. The player attribute should be
        considered <strong>at risk</strong> unless a strong use case for the
        reference arises.

</div>

<div class='methods'>

:	<dfn method for=AnimationNode title='before()'>
    void before (AnimationNode... nodes)</dfn>
::  Inserts <var>nodes</var> before this <a>animation node</a>.
	
    1.	If there is no <a>parent animation group</a>, terminate these
        steps.
	2.	If any of the <a>animation nodes</a> in <var>nodes</var> is an
        <a>inclusive ancestor</a> of this <a>animation node</a>
        throw a <code>HierarchyRequestError</code> exception and
        terminate these steps. 
    3.	<a title="insert children">Insert</a> <var>nodes</var> before
        this <a>animation node</a>.

    <div class='note'>
        Note that this definition precludes the following usage since
        <code>node</code> is an <a>inclusive ancestor</a> of itself:
        
        FIXME: pre needs to work in lists.
        
	    <div class="example sh_javascript">
            node.before(node); // throws HierarchyRequestError
        </div>
    </div>

:	<dfn method for=AnimationNode title='after()'>
    void after(AnimationNode... nodes)</dfn>
::	Inserts <var>nodes</var> after this <a>animation node</a>.

    1.	If there is no <a>parent animation group</a>, terminate these
        steps.
    2.	If any of the <a>animation nodes</a> in <var>nodes</var> is an
        <a>inclusive ancestor</a> of this <a>animation node</a>
        throw a <code>HierarchyRequestError</code> exception and
        terminate these steps. 
    3.	Let <var>reference child</var> be the <a
        title="next sibling not included">next sibling of
        this animation node not in <var>nodes</var></a>.
    4.	<a title="insert children">Insert</a> <var>nodes</var> before
        <var>reference child</var>.

:	<dfn method for=AnimationNode title='replace()'>
    void replace(AnimationNode... nodes)</dfn>
::  Replaces this <a>AnimationNode</a> with the passed in
	<var>nodes</var>.

    1.  If there is no <a>parent animation group</a>, terminate these
        steps.
    2.	If any of the <a>animation nodes</a> in <var>nodes</var> is an
        <a>inclusive ancestor</a> of the <a>parent animation group</a>
        throw a <code>HierarchyRequestError</code> exception and
        terminate these steps. 
    3.	Let <var>reference child</var> be the <a
        title="next sibling not included">next sibling of
        this animation node not in <var>nodes</var></a>.
    4.	<a title="remove an animation node">Remove</a> this
        <a>animation node</a> from its <a>parent animation group</a>.
    5.	<a title="insert children">Insert</a> <var>nodes</var> before
        <var>reference child</var>.

:	<dfn method for=AnimationNode title='remove()'>void remove()</dfn>
::	<a title="remove an animation node">Removes</a> this <a>animation
    node</a> from its <a>parent animation group</a> or <a>player</a>.

</div>